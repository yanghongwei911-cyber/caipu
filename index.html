<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§å¥‡å¥‡çš„ç¾å‘³æŒ‡ä»¤</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* --- V36 æ ·å¼ --- */
        :root { --primary: #FF7E67; --bg: #FFFBF5; --card-bg: #FFFFFF; --text-main: #5D5550; --text-sub: #AFA6A0; --lunch-color: #FFB03B; --dinner-color: #9D8FFF; --bf-color: #7ED38C; --radius: 12px; }
        body { font-family: "PingFang SC", -apple-system, sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 15px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: center; align-items: center; border-bottom: 1px dashed rgba(0,0,0,0.05); }
        .header h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--primary); letter-spacing: 1px; }
        
        /* å·¦ä¾§æŒ‰é’®ç»„ (ä¿®å¤ç‚¹) */
        .header-left-group { position: absolute; left: 15px; display: flex; gap: 15px; align-items: center; }
        .header-icon { font-size: 20px; cursor: pointer; }
        
        /* åŒæ­¥åŠ¨ç”» */
        .spinning { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .header-btn-right { position: absolute; right: 15px; font-size: 12px; background: #FFF0EB; color: var(--primary); padding: 5px 10px; border-radius: 15px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .header-btn-right.saving-mode { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 126, 103, 0.3); }

        .tabs { display: flex; background: #F5F0EB; padding: 4px; margin: 10px 15px; border-radius: 25px; }
        .tab { flex: 1; text-align: center; padding: 8px 0; font-size: 14px; font-weight: 700; color: var(--text-sub); border-radius: 20px; transition: 0.2s; }
        .tab.active { background: #FFFFFF; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section { display: none; padding: 0 15px; }
        .section.active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; min-height: 10px; }
        .cat-wrapper { margin-bottom: 20px; }
        body.edit-mode .cat-wrapper { background: rgba(255,255,255,0.5); padding: 8px; border: 2px dashed #FFD1C7; border-radius: 15px; }
        .cat-header { display: flex; justify-content: space-between; align-items: center; padding: 5px; margin-bottom: 5px; }
        .cat-title { font-size: 16px; font-weight: 800; color: #5D5550; display: flex; align-items: center; gap: 6px; }
        .cat-title::before { content:''; width:6px; height:6px; background:var(--primary); border-radius:50%; opacity: 0.6; }
        .tools { display: none; align-items: center; gap: 12px; }
        body.edit-mode .tools { display: flex; }
        .icon-btn { font-size: 14px; color: var(--text-sub); padding: 4px; }
        .drag-handle { font-size: 20px; color: #D1C7C0; cursor: grab; padding: 0 10px; touch-action: none; }
        .card { background: #FFFFFF; border-radius: var(--radius); position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.03); aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 4px; border: 2px solid transparent; transition: all 0.1s; -webkit-touch-callout: none; overflow: hidden; }
        .card:active { transform: scale(0.92); }
        .card-name { font-size: 15px; font-weight: 800; color: #5D5550; margin: 0; line-height: 1.2; width: 100%; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .card.sel-bf { background: var(--bf-color); color: white; border-color: var(--bf-color); }
        .card.sel-lunch { background: var(--lunch-color); color: white; border-color: var(--lunch-color); }
        .card.sel-dinner { background: var(--dinner-color); color: white; border-color: var(--dinner-color); }
        .card.sel-both { background: var(--primary); color: white; border-color: var(--primary); }
        .card[class*="sel-"] .card-name { color: white; }
        .count-badge { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.2); color: white; font-size: 10px; padding: 1px 5px; border-radius: 8px; font-weight: bold; display: none; }
        .card.has-count .count-badge { display: block; }
        .note-dot { position: absolute; bottom: 4px; width: 4px; height: 4px; border-radius: 50%; background: rgba(255,255,255,0.8); display: none; }
        .card.has-note .note-dot { display: block; }
        .card-edit-btn { position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 10; color: var(--primary); font-weight: bold; font-size: 12px; border-radius: var(--radius); }
        body.edit-mode .card-edit-btn { display: flex; }
        body.edit-mode .card { border: 1px dashed #E0D8D5; background: #FCFAF9; box-shadow: none; }
        .settings-panel { background: white; padding: 15px; border-radius: 20px; margin-bottom: 20px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .chip { padding: 6px 12px; background: #F7F4F2; border-radius: 15px; font-size: 12px; position: relative; color: #6D635E; font-weight: 600; transition: 0.2s; }
        .chip.bf-active { background: var(--bf-color); color: white; }
        .chip.lunch-active { background: var(--lunch-color); color: white; }
        .chip.dinner-active { background: var(--dinner-color); color: white; }
        .chip-del { position: absolute; top: -5px; right: -5px; width: 16px; height: 16px; background: #FF6B6B; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; border: 1px solid white; }
        body.edit-mode .chip-del { display: flex; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 12px 20px; z-index: 200; padding-bottom: max(15px, env(safe-area-inset-bottom)); box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .btn-submit { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 25px; font-weight: 700; font-size: 16px; box-shadow: 0 8px 20px rgba(255, 126, 103, 0.3); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(93, 85, 80, 0.4); z-index: 300; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-sheet { background: #FFFFFF; width: 100%; max-width: 500px; border-radius: 25px 25px 0 0; padding: 25px; padding-bottom: max(30px, env(safe-area-inset-bottom)); max-height: 85vh; overflow-y: auto; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #F2EEEA; border-radius: 12px; box-sizing: border-box; background: #FCFAF8; font-size: 15px; margin-bottom: 10px; color: var(--text-main); }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; background: white; }
        .btn-full { width: 100%; padding: 12px; border-radius: 15px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #FFB0B0; color: white; }
        .btn-secondary { background: #F0EBE8; color: #6D635E; }
        .btn-cancel-item { font-size: 13px; color: #FF6B6B; background: #FFF0F0; border: 1px solid #FFDEDE; padding: 6px 12px; border-radius: 15px; cursor: pointer; float: right; margin-top: 10px; font-weight: 600; }
        .meal-section { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; border: 2px solid #F5F0ED; transition: 0.2s; }
        .meal-section.active { border-color: var(--primary); background: #FFF5F2; }
        .meal-section.active-bf { border-color: var(--bf-color); background: #F2FDF5; }
        .meal-header { display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 16px; }
        .detail-box { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed rgba(0,0,0,0.08); }
        .meal-section.active .detail-box, .meal-section.active-bf .detail-box { display: block; }
        .stepper { display: flex; gap: 15px; align-items: center; }
        .step-btn { width: 32px; height: 32px; background: white; border: 2px solid #EFEBE9; border-radius: 50%; color: var(--primary); font-weight: 900; font-size: 18px; display:flex; align-items:center; justify-content:center; }
        .toggle-row { display: flex; background: #F0EBE8; padding: 4px; border-radius: 12px; margin-bottom: 12px; }
        .toggle-opt { flex: 1; text-align: center; padding: 10px; font-size: 14px; border-radius: 10px; color: #999; font-weight: 600; }
        .toggle-opt.selected { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .action-group { display: flex; gap: 15px; margin-top: 10px; }
        .action-group .btn-full { margin-top: 0; }
        .search-box { margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 15px; border: 2px solid #F2EEEA; border-radius: 25px; background: #FFFFFF; font-size: 15px; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 4px 12px rgba(255, 126, 103, 0.15); }
        .backup-textarea { width: 100%; height: 100px; font-family: monospace; font-size: 11px; color: #666; border: 1px solid #ccc; background: #f9f9f9; word-break: break-all;}
    </style>
</head>
<body>

<div class="header">
    <div class="header-left-group">
        <div class="header-icon" onclick="openBackupModal()">âš™ï¸</div>
        <div class="header-icon" id="syncBtn" onclick="forceSync()">â˜ï¸</div>
    </div>
    <h1>ğŸ€ å¤§å¥‡å¥‡çš„ç¾å‘³æŒ‡ä»¤ ğŸ€</h1>
    <div class="header-btn-right" id="mainActionBtn" onclick="toggleEditMode()">âœ ç¼–è¾‘èœå•</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('bf')">â˜€ï¸ æ—©é¤æ—¶å…‰</div>
    <div class="tab" onclick="switchTab('main')">ğŸ± åˆé¤æ™šé¤</div>
</div>

<div id="tab-bf" class="section active">
    <div class="settings-panel">
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:800; color:var(--bf-color);">â˜€ï¸ æ—©é¤å‡ äººåƒ?</span>
            <span class="tools icon-btn" onclick="editLabel('bfPpl')">âœ</span>
        </div>
        <div class="chip-container" id="chips-bfPpl"></div>
    </div>
    <div id="container-bf"></div>
    <button class="btn-full btn-primary" id="add-cat-bf" style="display:none; margin-top:20px; background:#81CFE0;" onclick="addCategory('bf')">+ æ–°å¢æ—©é¤ç§ç±»</button>
</div>

<div id="tab-main" class="section">
    <div class="settings-panel">
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:800; color:var(--lunch-color);">ğŸ± å‡ ä¸ªäººå¸¦é¥­?</span>
            <span class="tools icon-btn" onclick="editLabel('lunchPpl')">âœ</span>
        </div>
        <div class="chip-container" id="chips-lunchPpl"></div>
        <input type="text" id="input-lunch-extra" placeholder="å¤‡æ³¨ (å¦‚: æƒ³è¦åƒçº¢è–¯)" style="margin-top:12px;">
        <div style="height:25px;"></div>
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:800; color:var(--dinner-color);">ğŸŒ™ æ™šé¤å‡ ä¸ªäººåƒ?</span>
            <span class="tools icon-btn" onclick="editLabel('dinnerRice')">âœ</span>
        </div>
        <div class="chip-container" id="chips-dinnerRice"></div>
        <input type="text" id="input-dinner-extra" placeholder="å¤‡æ³¨ (å¦‚: åƒåœŸè±†/ä¸åƒç±³é¥­)" style="margin-top:12px;">
    </div>
    
    <div class="search-box">
        <input type="search" id="mainSearch" class="search-input" placeholder="ğŸ” æœä¸€æœ (å¦‚: é¸¡, èŠ¹èœ, åœŸè±†...)" oninput="handleSearch()">
    </div>

    <div id="container-main"></div>
    <button class="btn-full btn-primary" id="add-cat-main" style="display:none; margin-top:20px; background:#81CFE0;" onclick="addCategory('main')">+ æ–°å¢æ­£é¤ç§ç±»</button>
    <div class="cat-wrapper" style="margin-top:25px;">
        <div class="cat-title" style="font-size:16px; margin-bottom:10px;">ğŸ’Œ ç»™é˜¿å§¨çš„æ‚„æ‚„è¯</div>
        <textarea id="global-note" rows="3" placeholder="ä¾‹å¦‚ï¼šè®°å¾—æ”¶å¿«é€’ã€æ‰“æ‰«å«ç”Ÿå‘€..."></textarea>
    </div>
</div>

<div class="footer">
    <button class="btn-submit" onclick="generate()">âœ¨ ç”Ÿæˆå¤§å¥‡å¥‡çš„æŒ‡ä»¤ âœ¨</button>
</div>

<div id="backupModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-title" style="margin-bottom:10px;">âš™ï¸ è®¾ç½® & å¤‡ä»½</div>
        <div style="background:#FFF0F0; padding:15px; border-radius:15px; margin-bottom:20px; text-align:center;">
            <p style="color:#FF6B6B; font-weight:bold; margin-bottom:5px;">âš ï¸ é‡ç½®æ•°æ®</p>
            <button class="btn-full btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ å¼ºåŠ›æ¸…ç©º (æ‹‰å–GitHubé»˜è®¤)</button>
        </div>
        <p style="font-size:13px; color:#666; margin-bottom:10px;"><b>å¤‡ä»½ä»£ç </b> (æ‰‹åŠ¨åŒæ­¥ç”¨):</p>
        <textarea id="backup-area" class="backup-textarea"></textarea>
        <div class="action-group">
            <button class="btn-full btn-secondary" onclick="doExport()">ğŸ“¤ å¤åˆ¶å¤‡ä»½</button>
            <button class="btn-full btn-primary" onclick="doImport()">ğŸ“¥ ç²˜è´´æ¢å¤</button>
        </div>
        <button class="btn-full" style="background:transparent; color:#999; margin-top:10px;" onclick="closeModal('backupModal')">å…³é—­</button>
    </div>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <span class="sheet-title" id="om-title"></span>
            <span style="font-size:28px;color:#E0D8D5; line-height:20px;" onclick="closeModal('orderModal')">Ã—</span>
        </div>
        <div id="panel-bf" style="display:none;">
            <div class="meal-section" id="sec-bf" onclick="toggleMeal('bf')">
                <div class="meal-header"><span>â˜€ï¸ æ—©é¤åƒè¿™ä¸ª</span><span id="chk-bf" style="color:var(--bf-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold; color:#888;">æ•°é‡</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('bf',-1)">-</button><span id="qty-bf" style="font-weight:900; font-size:18px; width:25px; text-align:center; color:var(--text-main);">1</span><button class="step-btn" onclick="adjQty('bf',1)">+</button></div>
                    </div>
                    <input type="text" id="note-bf" placeholder="å¤‡æ³¨ (å¦‚: å°‘ç³–)">
                    <button class="btn-cancel-item" onclick="event.stopPropagation(); toggleMeal('bf')">ğŸ—‘ï¸ ä¸åƒè¿™ä¸ªäº†</button><div style="clear:both"></div>
                </div>
            </div>
        </div>
        <div id="panel-main" style="display:none;">
            <div class="meal-section" id="sec-lunch" onclick="toggleMeal('lunch')">
                <div class="meal-header"><span>ğŸ± åˆé¤åƒè¿™ä¸ª</span><span id="chk-lunch" style="color:var(--lunch-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold; color:#888;">ä»½æ•°</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('lunch',-1)">-</button><span id="qty-lunch" style="font-weight:900; font-size:18px; width:25px; text-align:center; color:var(--text-main);">1</span><button class="step-btn" onclick="adjQty('lunch',1)">+</button></div>
                    </div>
                    <input type="text" id="note-lunch" placeholder="å¤‡æ³¨ (å¦‚: å°‘è¾£)">
                    <button class="btn-cancel-item" onclick="event.stopPropagation(); toggleMeal('lunch')">ğŸ—‘ï¸ ä¸åƒè¿™ä¸ªäº†</button><div style="clear:both"></div>
                </div>
            </div>
            <div class="meal-section" id="sec-dinner" onclick="toggleMeal('dinner')">
                <div class="meal-header"><span>ğŸŒ™ æ™šé¤åƒè¿™ä¸ª</span><span id="chk-dinner" style="color:var(--dinner-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold; color:#888;">ä»½æ•°</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('dinner',-1)">-</button><span id="qty-dinner" style="font-weight:900; font-size:18px; width:25px; text-align:center; color:var(--text-main);">1</span><button class="step-btn" onclick="adjQty('dinner',1)">+</button></div>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-opt selected" id="opt-cook" onclick="setDinnerMode('cook')">ğŸ‘©â€ğŸ³ é˜¿å§¨åšç†Ÿ</div>
                        <div class="toggle-opt" id="opt-prep" onclick="setDinnerMode('prep')">ğŸ”ª å¸®å¿™åˆ‡é…</div>
                    </div>
                    <input type="text" id="note-dinner" placeholder="æ€ä¹ˆåš? / æ€ä¹ˆåˆ‡?">
                    <button class="btn-cancel-item" onclick="event.stopPropagation(); toggleMeal('dinner')">ğŸ—‘ï¸ ä¸åƒè¿™ä¸ªäº†</button><div style="clear:both"></div>
                </div>
            </div>
        </div>
        <button class="btn-full btn-primary" onclick="confirmOrder()">å°±é€‰å®ƒå•¦ï¼â¤ï¸</button>
    </div>
</div>

<div id="dishModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-title" id="dm-title" style="margin-bottom:20px;"></div>
        <label style="font-weight:700; margin-bottom:5px; display:block;">èœå“åç§°</label>
        <input type="text" id="dm-name" placeholder="å¦‚: ç•ªèŒ„ç‚’è›‹">
        <label style="font-weight:700; margin-bottom:5px; display:block;">é»˜è®¤å¤‡æ³¨ (è®°å¿†)</label>
        <input type="text" id="dm-prep" placeholder="å¦‚: åˆ‡å°å—">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-full btn-danger" id="dm-btn-del" onclick="deleteDish()">åˆ é™¤</button>
            <button class="btn-full btn-primary" onclick="saveDishTemp()">ä¿å­˜å¥½å•¦</button>
        </div>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-title" style="margin-bottom:15px; text-align:center;">ğŸ’Œ ç”Ÿæˆå¥½å•¦</div>
        <textarea id="final-text" style="height:200px; border-color:var(--primary); background:#FFF9F9;"></textarea>
        <div class="action-group">
            <button class="btn-full btn-secondary" onclick="closeModal('resultModal')">ğŸ”™è¿˜è¦æ”¹æ”¹</button>
            <button class="btn-full btn-primary" id="btn-copy" onclick="copyText()">ğŸ“„ å¤åˆ¶ç»™é˜¿å§¨</button>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // ğŸŸ¢ ä½ çš„äº‘ç«¯å¯†é’¥
    // ============================================================
    const BIN_ID = "69211680ae596e708f6893ae"; 
    const API_KEY = "$2a$10$NEHjOsfUfM1jAmhv/bKlAe1/0Zx4qaXfxjviJtcBeFus9q2IukiK6";
    // ============================================================

    const defaultData = {"bf":{"ğŸ¥ª ä¸»é£Ÿç±»":[{"n":"æ°´ç…®ç‰ç±³","prep":""},{"n":"é¢åŒ…","prep":""},{"n":"çº¢è–¯"},{"n":"å°ç±³ç²¥","prep":""},{"n":"çº¢è±†ç²¥æˆ‘ä»¬å·²ç»åšå¥½äº†","prep":""},{"n":"å—ç“œ","prep":""},{"n":"ç‰ç±³ç³Šç³Š","prep":""}],"ğŸ¥› é¥®å“æµé£Ÿç±»":[{"n":"ç‰›å¥¶"},{"n":"è±†æµ†"},{"n":"å’–å•¡"}],"ğŸ¥š é¸¡è›‹ç±»":[{"n":"æ°´ç…®è›‹","prep":""},{"n":"é¸¡è›‹ç¾¹","prep":""},{"n":"ç…é¸¡è›‹","prep":""},{"n":"è·åŒ…è›‹å¸¦æ±¤è‘±èŠ±","prep":""}],"é¸¡è›‹ç‚’èœç±»":[{"n":"è èœç‚’è›‹","prep":""},{"n":"é»„ç“œç‚’è›‹","prep":""},{"n":"ç•ªèŒ„ç‚’è›‹","prep":""}],"ğŸ¥¬ç´ èœç±»":[{"n":"éšä¾¿ç‚’ä¸€ä¸ªè”¬èœ","prep":""},{"n":"å‡‰æ‹Œè¥¿å…°èŠ±","prep":""},{"n":"å‡‰æ‹Œè±†èŠ½","prep":""},{"n":"é¦™è‡ç‚’é’èœ","prep":""}]},"main":{"ğŸ”é¸¡ç±»":[{"n":"æ¸…ç‚–é¸¡é…è˜¸æ–™","prep":""},{"n":"å°ç‚’é¸¡","prep":""},{"n":"é…¸è¾£é¸¡èƒ—","prep":""},{"n":"çº¢çƒ§é¸¡","prep":""},{"n":"ç™½åˆ‡é¸¡é…è˜¸æ–™","prep":""}],"ğŸ‚ç‰›ç±»":[{"n":"è¾£æ¤’ç‚’ç‰›è‚‰","prep":""},{"n":"é¦™èœç‚’ç‰›è‚‰","prep":"åˆ‡é…é¦™èœè·Ÿç‰›è‚‰"},{"n":"å½©æ¤’æ´‹è‘±ç‚’ç‰›è‚‰","prep":""},{"n":"åœŸè±†ç‚–ç‰›è…©","prep":""},{"n":"ç‰›è‚‰ç‚’èŠ¹èœ","prep":"éœ€è¦åˆ‡å¤§è‘±æ–œåˆ‡åˆ‡ä¸ï¼Œç‰›è‚‰åˆ‡ç‰‡ï¼Œèºä¸æ¤’ä¸€ä¸ªæ–œåˆ‡ï¼Œå¤§è’œ 3 ä¸ªï¼Œç•ªèŒ„ä¸€ä¸ªåˆ‡å—"},{"n":"ç‰›è‚‰ç‚–ç™½èåœ","prep":""}],"ğŸ¦†é¸­ç±»":[{"n":"æ¸…ç‚–é¸­é…è˜¸æ–™","prep":""},{"n":"çº¢çƒ§é¸­","prep":""},{"n":"å°ç‚’é¸­","prep":""}],"æµ·é²œç±»":[{"n":"æ¸…è’¸é±¼","prep":""},{"n":"çº¢çƒ§é±¼","prep":""},{"n":"ç™½ç¼è™¾","prep":""},{"n":"çº¢çƒ§è™¾","prep":""},{"n":"é’æ¤’ç‚’é±¿é±¼","prep":""}],"ç´ èœç±»":[{"n":"ç´ èœä½ çœ‹ç€å®‰æ’","prep":"éšä¾¿åˆ‡é…ä¸€ä¸ªè”¬èœï¼Œè¿˜æœ‰é… 3ä¸ªè’œåˆ‡ç‰‡ï¼Œä¸€ä¸ªå°ç±³è¾£"},{"n":"é…¸è¾£åœŸè±†ä¸","prep":""},{"n":"é…¸è¾£åŒ…åŒ…èœ","prep":""},{"n":"é¦™è‡ç‚’é’èœ","prep":""},{"n":"èŒ­ç™½ä¸ç‚’é’æ¤’","prep":""},{"n":"ç‚’è±†è§’","prep":""}],"è±†è…ç±»":[{"n":"å®¶å¸¸è±†è…","prep":""},{"n":"éº»å©†è±†è…","prep":""},{"n":"çº¢çƒ§ç´ é¸¡","prep":""}],"é¸¡è›‹ç±»":[{"n":"éŸ­èœç‚’è›‹","prep":""},{"n":"å¤œå¼€èŠ±ç‚’é¸¡è›‹","prep":""}],"å‡‰æ‹Œèœ":[{"n":"å‡‰æ‹Œè´ç¬‹","prep":""},{"n":"å‡‰æ‹Œè±†èŠ½","prep":""},{"n":"å‡‰æ‹Œç§‹è‘µ","prep":""}],"æ±¤ç±»":[]},"options":{"bfPpl":["1äºº","2äºº","3 äºº"],"lunchPpl":["1äººå¸¦é¥­","2äººå¸¦é¥­","3 äººå¸¦é¥­","ä¸å¸¦é¥­"],"dinnerRice":["1äººç±³é¥­","2 äººç±³é¥­","3 äººç±³é¥­","è’¸åœŸè±†"]},"labels":{"bfPpl":"æ—©é¤å‡ äººåƒ","lunchPpl":"å‡ ä¸ªäººå¸¦é¥­","dinnerRice":"æ™šé¤å‡ ä¸ªäººåƒ"}};
    
    let data = {}; let orders = {}; let orderCtx=null; let editCtx=null; let tmpB=""; let tmpL=""; let tmpD="";

    async function init() {
        if (BIN_ID.includes("è¯·åœ¨")) {
            const saved = localStorage.getItem('aygj_v36_local');
            data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
            renderAll();
            return;
        }
        await loadFromCloud();
    }

    // --- æœç´¢é€»è¾‘ ---
    function handleSearch() {
        const kw = document.getElementById('mainSearch').value.trim();
        const container = document.getElementById('container-main');
        if (!kw) { renderTab('main', 'container-main'); return; }
        container.innerHTML = "";
        const grid = document.createElement('div'); grid.className = "grid"; grid.style.marginTop = "10px";
        let foundCount = 0;
        for (let cat in data.main) {
            data.main[cat].forEach((item, idx) => {
                if (item.n.includes(kw)) { grid.appendChild(createCard(item, 'main', cat, idx)); foundCount++; }
            });
        }
        if (foundCount === 0) container.innerHTML = `<div style="text-align:center;color:#999;padding:20px;">ğŸ¤·â€â™‚ï¸ æ²¡æ‰¾åˆ°...</div>`;
        else {
            const tip = document.createElement('div'); tip.style.color = "var(--primary)"; tip.style.fontSize="13px"; tip.style.marginBottom="10px"; tip.innerText = `ğŸ” æ‰¾åˆ° ${foundCount} ä¸ª:`;
            container.appendChild(tip); container.appendChild(grid);
        }
    }

    // --- äº‘ç«¯é€»è¾‘ ---
    async function loadFromCloud() {
        const btn = document.getElementById('syncBtn'); btn.classList.add('spinning');
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
            if (!res.ok) throw new Error("Failed");
            const json = await res.json();
            data = json.record;
            if (!data.bf || Object.keys(data.bf).length === 0) { data = JSON.parse(JSON.stringify(defaultData)); await saveToCloud(); }
            renderAll(); localStorage.setItem('aygj_v36_local', JSON.stringify(data)); 
        } catch (e) {
            const saved = localStorage.getItem('aygj_v36_local');
            data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultData));
            renderAll();
        } finally { btn.classList.remove('spinning'); }
    }

    async function saveToCloud() {
        const btn = document.getElementById('syncBtn'); btn.classList.add('spinning');
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify(data) });
            if (!res.ok) throw new Error("Save failed");
            localStorage.setItem('aygj_v36_local', JSON.stringify(data)); return true;
        } catch (e) { alert("âŒ åŒæ­¥å¤±è´¥"); return false; } finally { btn.classList.remove('spinning'); }
    }

    function forceSync() { if(confirm("â˜ï¸ ç¡®å®šè¦ä»äº‘ç«¯æ‹‰å–æœ€æ–°èœå•å—ï¼Ÿ")) { loadFromCloud(); } }

    // --- å¸¸è§„é€»è¾‘ ---
    async function toggleEditMode() {
        const body = document.body; const btn = document.getElementById('mainActionBtn');
        if (body.classList.contains('edit-mode')) {
            if(BIN_ID.includes("è¯·åœ¨")) { localStorage.setItem('aygj_v36_local', JSON.stringify(data)); alert("âœ… æœ¬åœ°ä¿å­˜æˆåŠŸ"); exitEdit(); } 
            else if(await saveToCloud()) { alert("â˜ï¸ èœå•å·²åŒæ­¥åˆ°äº‘ç«¯ï¼"); exitEdit(); }
        } else {
            body.classList.add('edit-mode'); btn.innerText="ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥"; btn.classList.add('saving-mode'); 
            document.getElementById('add-cat-bf').style.display='block'; document.getElementById('add-cat-main').style.display='block'; renderAll();
        }
    }
    
    function exitEdit() {
        const body = document.body; const btn = document.getElementById('mainActionBtn');
        body.classList.remove('edit-mode'); btn.innerText="âœ ç¼–è¾‘èœå•"; btn.classList.remove('saving-mode'); 
        document.getElementById('add-cat-bf').style.display='none'; document.getElementById('add-cat-main').style.display='none'; renderAll();
    }

    function renderAll() { renderTab('bf', 'container-bf'); renderTab('main', 'container-main'); renderSettings(); }
    function renderTab(tab, containerId) {
        if (containerId === 'container-main' && document.getElementById('mainSearch') && document.getElementById('mainSearch').value.trim() !== "") return;
        const container = document.getElementById(containerId); container.innerHTML = "";
        const isEdit = document.body.classList.contains('edit-mode'); const db = data[tab];
        if(!db) return;
        for (let cat in db) {
            const wrapper = document.createElement('div'); wrapper.className="cat-wrapper"; wrapper.dataset.cat=cat;
            const header = document.createElement('div'); header.className="cat-header";
            header.innerHTML = `<div class="cat-title"><span>${cat}</span><span class="tools"><span class="icon-btn" onclick="renameCat('${tab}','${cat}')">âœ</span><span class="icon-btn" style="color:#FF6B6B" onclick="delCat('${tab}','${cat}')">ğŸ—‘</span></span></div><div style="display:flex;align-items:center;gap:10px;"><span class="tools icon-btn" style="color:var(--primary);font-weight:bold;" onclick="openDishModal('${tab}','${cat}',-1)">+ åŠ èœ</span>${isEdit?'<span class="drag-handle">â‰¡</span>':''}</div>`;
            const grid = document.createElement('div'); grid.className="grid";
            db[cat].forEach((item, idx) => { grid.appendChild(createCard(item, tab, cat, idx)); });
            wrapper.appendChild(header); wrapper.appendChild(grid); container.appendChild(wrapper);
            if(isEdit) new Sortable(grid, { animation:200, delay:200, delayOnTouchOnly:true, ghostClass:'sortable-ghost', dragClass:'sortable-drag', onEnd:(evt)=>{const i=data[tab][cat].splice(evt.oldIndex,1)[0]; data[tab][cat].splice(evt.newIndex,0,i);} });
        }
        if(isEdit) new Sortable(container, { animation:200, handle:'.drag-handle', onEnd:(evt)=>{const n={}; container.querySelectorAll('.cat-wrapper').forEach(w=>{n[w.dataset.cat]=data[tab][w.dataset.cat]}); data[tab]=n;} });
    }
    function createCard(item, tab, cat, idx) {
        const div = document.createElement('div'); const order = orders[item.n]; let cls = "card"; let countHtml=""; let noteHtml="";
        if(order) {
            let d=null;
            if(order.bf?.active) { cls+=" sel-bf"; d=order.bf; }
            if(order.lunch?.active) { cls+=" sel-lunch"; d=order.lunch; }
            if(order.dinner?.active) { if(cls.includes("sel-lunch")) cls="card sel-both"; else cls+=" sel-dinner"; d=order.dinner; }
            if(d && d.count>1) { cls+=" has-count"; countHtml=`<div class="count-badge">x${d.count}</div>`; }
            if(d && (d.note || (d.mode==='prep'))) { cls+=" has-note"; noteHtml=`<div class="note-dot"></div>`; }
        }
        div.className = cls;
        div.innerHTML = `<div class="card-name">${item.n}</div>${countHtml}${noteHtml}<div class="card-edit-btn" onclick="event.stopPropagation();openDishModal('${tab}','${cat}',${idx})">âœ</div>`;
        div.onclick = () => { if(!document.body.classList.contains('edit-mode')) openOrderModal(item, tab); };
        return div;
    }
    function addCategory(tab) { const n=prompt("æ–°åˆ†ç±»åç§°ï¼š"); if(n){if(!data[tab])data[tab]={}; if(data[tab][n]){alert("æœ‰äº†");return;} data[tab][n]=[]; renderAll();} }
    function renameCat(tab, old) { const n=prompt("æ–°åå­—", old); if(n&&n!==old&&!data[tab][n]){const i=data[tab][old]; delete data[tab][old]; data[tab][n]=i; renderAll();} }
    function delCat(tab, cat) { if(confirm(`åˆ é™¤ã€${cat}ã€‘ï¼Ÿ`)){delete data[tab][cat]; renderAll();} }

    function openDishModal(tab, cat, idx) {
        editCtx = { tab, cat, idx, isNew: idx===-1 }; const item = idx===-1 ? {n:"", prep:""} : data[tab][cat][idx];
        document.getElementById('dm-title').innerText = editCtx.isNew?"âœ¨ æ·»åŠ ç¾é£Ÿ":"âœ¨ ä¿®æ”¹ç¾é£Ÿ"; document.getElementById('dm-name').value = item.n; document.getElementById('dm-prep').value = item.prep||"";
        document.getElementById('dm-btn-del').style.display = editCtx.isNew?'none':'block'; document.getElementById('dishModal').classList.add('show');
    }
    function saveDishTemp() {
        const n = document.getElementById('dm-name').value; if(!n) return;
        const item = { n, prep: document.getElementById('dm-prep').value };
        if(editCtx.isNew) data[editCtx.tab][editCtx.cat].push(item); else data[editCtx.tab][editCtx.cat][editCtx.idx] = item;
        closeModal('dishModal'); 
        document.getElementById('mainSearch').value = ""; 
        renderAll();
    }
    function deleteDish() { if(confirm("åˆ é™¤ï¼Ÿ")){data[editCtx.tab][editCtx.cat].splice(editCtx.idx, 1); delete orders[document.getElementById('dm-name').value]; closeModal('dishModal'); document.getElementById('mainSearch').value = ""; renderAll();} }

    function openOrderModal(item, tab) {
        orderCtx={item,tab}; const order=orders[item.n]||{}; document.getElementById('om-title').innerText=item.n;
        document.getElementById('panel-bf').style.display=tab==='bf'?'block':'none'; document.getElementById('panel-main').style.display=tab==='main'?'block':'none';
        document.getElementById('note-bf').value=""; document.getElementById('note-lunch').value=""; document.getElementById('note-dinner').value="";
        if(tab==='bf'){ updateUI('bf', order.bf); if(!order.bf||!order.bf.active) toggleMeal('bf'); }
        else { updateUI('lunch', order.lunch); updateUI('dinner', order.dinner); const m=order.dinner?.mode||'cook'; setDinnerMode(m,false);
        if(order.dinner?.note) document.getElementById('note-dinner').value=order.dinner.note; else if(m==='prep'&&item.prep) document.getElementById('note-dinner').value=item.prep; }
        document.getElementById('orderModal').classList.add('show');
    }
    function toggleMeal(t) {
        const sec = document.getElementById(t==='bf'?'sec-bf':(t==='lunch'?'sec-lunch':'sec-dinner')); const chk = document.getElementById(t==='bf'?'chk-bf':(t==='lunch'?'chk-lunch':'chk-dinner')); const cls = t==='bf'?'active-bf':'active';
        sec.classList.toggle(cls); if(sec.classList.contains(cls)){ chk.innerHTML="â¤ï¸"; const id=t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner'); if(document.getElementById(id).innerText==="0")document.getElementById(id).innerText="1"; } else { chk.innerHTML=""; }
    }
    function updateUI(t,d) {
        const sec=document.getElementById(t==='bf'?'sec-bf':(t==='lunch'?'sec-lunch':'sec-dinner')); const chk=document.getElementById(t==='bf'?'chk-bf':(t==='lunch'?'chk-lunch':'chk-dinner')); const qty=document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner')); const note=document.getElementById(t==='bf'?'note-bf':(t==='lunch'?'note-lunch':'note-dinner')); const cls=t==='bf'?'active-bf':'active';
        if(d&&d.active){sec.classList.add(cls);chk.innerHTML="â¤ï¸";qty.innerText=d.count;if(t!=='dinner')note.value=d.note||"";}else{sec.classList.remove(cls);chk.innerHTML="";qty.innerText="1";}
    }
    function confirmOrder() {
        const item=orderCtx.item; if(!orders[item.n])orders[item.n]={};
        if(orderCtx.tab==='bf'){ if(document.getElementById('sec-bf').classList.contains('active-bf')) orders[item.n].bf={active:true,count:getQty('bf'),note:getVal('note-bf')}; else delete orders[item.n].bf; }
        else {
            if(document.getElementById('sec-lunch').classList.contains('active')) orders[item.n].lunch={active:true,count:getQty('lunch'),note:getVal('note-lunch')}; else delete orders[item.n].lunch;
            if(document.getElementById('sec-dinner').classList.contains('active')) { const m=document.getElementById('sec-dinner').dataset.mode||'cook'; const n=getVal('note-dinner'); orders[item.n].dinner={active:true,count:getQty('dinner'),mode:m,note:n}; if(m==='prep'&&n){item.prep=n; saveToCloud();} } else delete orders[item.n].dinner;
        } closeModal('orderModal'); 
        if (document.getElementById('mainSearch').value) handleSearch(); else renderAll();
    }
    function getQty(t){return parseInt(document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner')).innerText);}
    function getVal(id){return document.getElementById(id).value;}
    function adjQty(t,d){const el=document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner')); let v=parseInt(el.innerText)+d; if(v<1)v=1; el.innerText=v;}
    function setDinnerMode(m,ui=true){ document.getElementById('sec-dinner').dataset.mode=m; document.getElementById('opt-cook').className=m==='cook'?'toggle-opt selected':'toggle-opt'; document.getElementById('opt-prep').className=m==='prep'?'toggle-opt selected':'toggle-opt'; if(ui)document.getElementById('note-dinner').value=m==='prep'?(orderCtx.item.prep||""):""; }
    function renderSettings(){ renderChips('chips-bfPpl', data.options.bfPpl, 'bfPpl'); renderChips('chips-lunchPpl', data.options.lunchPpl, 'lunchPpl'); renderChips('chips-dinnerRice', data.options.dinnerRice, 'dinnerRice'); }
    function renderChips(id,list,key){
        const el=document.getElementById(id); el.innerHTML="";
        list.forEach((txt,i)=>{
            const isSel=(key==='bfPpl'&&tmpB===txt)||(key==='lunchPpl'&&tmpL===txt)||(key==='dinnerRice'&&tmpD===txt);
            let cls=''; if(isSel){if(key==='bfPpl')cls='bf-active';if(key==='lunchPpl')cls='lunch-active';if(key==='dinnerRice')cls='dinner-active';}
            const d=document.createElement('div'); d.className=`chip ${cls}`; d.innerHTML=`${txt}<div class="chip-del" onclick="event.stopPropagation();delOpt('${key}',${i})">Ã—</div>`;
            d.onclick=()=>{if(!document.body.classList.contains('edit-mode')){if(key==='bfPpl')tmpB=(tmpB===txt?"":txt);else if(key==='lunchPpl')tmpL=(tmpL===txt?"":txt);else tmpD=(tmpD===txt?"":txt);renderSettings();}};
            el.appendChild(d);
        });
        const add=document.createElement('div'); add.className="chip"; add.style.border="1px dashed #FFD1C7"; add.style.background="white"; add.style.color="var(--primary)"; add.innerHTML="+";
        add.onclick=()=>{if(document.body.classList.contains('edit-mode')){const v=prompt("æ·»åŠ ");if(v){data.options[key].push(v);saveToCloud();renderSettings();}}};
        el.appendChild(add);
    }
    function delOpt(k,i){data.options[k].splice(i,1);saveToCloud();renderSettings();}
    function editLabel(k){const v=prompt("æ–°æ ‡é¢˜",data.labels[k]);if(v){data.labels[k]=v;saveToCloud();renderSettings();}}
    
    function generate(){
        const btn=document.getElementById('btn-copy'); btn.innerText="ğŸ“„ å¤åˆ¶ç»™é˜¿å§¨"; btn.style.backgroundColor="var(--primary)";
        let msg="é˜¿å§¨ï¼Œæ˜å¤©é¥­èœå®‰æ’ï¼š\n"; let bf=[], lu=[], dCook=[], dPrep=[];
        for(let k in orders){
            if(orders[k].bf?.active) bf.push(`${k}${orders[k].bf.count>1?' x'+orders[k].bf.count:''} ${orders[k].bf.note?('('+orders[k].bf.note+')'):''}`);
            if(orders[k].lunch?.active) lu.push(`${k}${orders[k].lunch.count>1?' x'+orders[k].lunch.count:''} ${orders[k].lunch.note?('('+orders[k].lunch.note+')'):''}`);
            if(orders[k].dinner?.active) {
                const d = orders[k].dinner;
                const s = `${k}${d.count>1?' x'+d.count:''}${d.note?' ('+d.note+')':''}`;
                if(d.mode==='prep') dPrep.push(s); else dCook.push(s);
            }
        }
        if(bf.length||tmpB) msg+=`\nâ˜€ï¸ã€æ—©é¤ã€‘${tmpB?(' '+tmpB):''}\n${bf.join('ï¼Œ')}`;
        if(lu.length||tmpL) msg+=`\n\nğŸ±ã€åˆé¤ã€‘${tmpL?(' '+tmpL):''}\n${lu.join('ï¼Œ')}${document.getElementById('input-lunch-extra').value?('\nè¡¥å……: '+document.getElementById('input-lunch-extra').value):''}`;
        if(dCook.length||dPrep.length||tmpD) {
            msg+=`\n\nğŸŒ™ã€æ™šé¤ã€‘${tmpD?(' '+tmpD):''}`;
            if(dCook.length) msg+=`\nğŸ‘©â€ğŸ³ éœ€åšç†Ÿï¼š\n- ${dCook.join('\n- ')}`;
            if(dPrep.length) msg+=`\nğŸ”ª éœ€åˆ‡é…ï¼š\n- ${dPrep.join('\n- ')}`;
            if(document.getElementById('input-dinner-extra').value) msg+=`\nè¡¥å……: ${document.getElementById('input-dinner-extra').value}`;
        }
        const gn=document.getElementById('global-note').value; if(gn) msg+=`\n\nğŸ“ã€å¤‡æ³¨ã€‘\n${gn}`;
        msg+="\n\nè¾›è‹¦é˜¿å§¨äº†ï¼";
        document.getElementById('final-text').value=msg; document.getElementById('resultModal').classList.add('show');
    }
    function copyText(){document.getElementById('final-text').select();document.execCommand('copy');const btn=document.getElementById('btn-copy');btn.innerText="âœ… å¤åˆ¶æˆåŠŸå•¦";btn.style.backgroundColor="#6BCB77";}
    function closeModal(id){document.getElementById(id).classList.remove('show');}
    function switchTab(t){document.getElementById('mainSearch').value=""; document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');document.getElementById('tab-'+t).classList.add('active'); renderAll();}
    function clearAllData(){if(confirm("âš ï¸ ç¡®å®šè¦é‡ç½®ï¼Ÿ\nè¿™å°†æ‹‰å–ã€GitHubé»˜è®¤èœå•ã€‘è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ã€‚")){localStorage.removeItem('aygj_v36_local');data=JSON.parse(JSON.stringify(defaultData));saveToCloud();renderAll();closeModal('backupModal');alert("âœ… æ•°æ®å·²é‡ç½®ï¼");}}
    function openBackupModal(){document.getElementById('backup-area').value=JSON.stringify(data);document.getElementById('backupModal').classList.add('show');}
    function doExport(){document.getElementById('backup-area').select();document.execCommand('copy');alert("âœ… å¤‡ä»½ä»£ç å·²å¤åˆ¶ï¼");}
    function doImport(){const str=document.getElementById('backup-area').value;if(!str){alert("è¯·å…ˆç²˜è´´å¤‡ä»½ä»£ç ï¼");return;}try{const d=JSON.parse(str);if(confirm("âš ï¸ ç¡®å®šè¦æ¢å¤å—ï¼Ÿ")){data=d;saveToCloud();renderAll();closeModal('backupModal');alert("ğŸ‰ æ¢å¤æˆåŠŸï¼");}}catch(e){alert("âŒ ä»£ç æ ¼å¼ä¸å¯¹å“¦");}}

    init();
</script>
</body>
</html>
