<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿å§¨ç‚¹é¤ V11 (è‡ªåŠ¨ä¿å­˜ç‰ˆ)</title>
    <style>
        /* ä¿æŒ V10 çš„æ‰€æœ‰ç²¾ç¾æ ·å¼ï¼Œæœªåšæ”¹åŠ¨ */
        :root {
            --primary: #007AFF; --lunch-color: #FF9500; --dinner-color: #5856D6;
            --bf-color: #34C759; --bg: #F2F2F7; --card-bg: #FFFFFF;
            --text-main: #1C1C1E; --text-sub: #8E8E93; --radius: 16px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            background-color: var(--bg); color: var(--text-main); margin: 0;
            padding-bottom: 180px; -webkit-tap-highlight-color: transparent; user-select: none;
        }
        .header {
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header h1 { margin: 0; font-size: 20px; font-weight: 800; }
        .edit-btn {
            font-size: 14px; color: var(--primary); background: rgba(0,122,255,0.1);
            padding: 6px 14px; border-radius: 20px; font-weight: 600; cursor: pointer;
        }
        .edit-btn.active { background: var(--primary); color: white; }
        .tabs {
            display: flex; background: var(--card-bg); padding: 5px; margin: 10px 15px;
            border-radius: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .tab {
            flex: 1; text-align: center; padding: 10px 0; font-size: 15px; font-weight: 600;
            color: var(--text-sub); border-radius: 10px; transition: 0.2s;
        }
        .tab.active { background: #E4EBF5; color: var(--primary); }
        .section { display: none; padding: 0 15px; }
        .section.active { display: block; }
        .cat-header { display: flex; justify-content: space-between; align-items: center; margin: 25px 5px 10px 5px; }
        .cat-title { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .cat-title::before { content:''; width:4px; height:16px; background:var(--primary); border-radius:2px; }
        .cat-edit-icon { font-size: 14px; color: #ccc; display: none; margin-left: 5px;}
        body.edit-mode .cat-edit-icon { display: inline-block; }
        .add-btn-text { color: var(--primary); font-size: 13px; font-weight: 600; cursor: pointer; }
        .settings-panel {
            background: var(--card-bg); padding: 15px; border-radius: var(--radius);
            margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .setting-row { margin-bottom: 15px; }
        .setting-row:last-child { margin-bottom: 0; }
        .setting-label { font-size: 13px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; display: flex; align-items: center; gap: 5px;}
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip {
            padding: 6px 12px; background: #F2F2F7; border-radius: 18px; font-size: 13px; font-weight: 500;
            position: relative; transition: 0.2s; cursor: pointer;
        }
        .chip.active { color: white; }
        .chip.lunch-active { background: var(--lunch-color); }
        .chip.dinner-active { background: var(--dinner-color); }
        .chip-del {
            position: absolute; top: -5px; right: -5px; width: 16px; height: 16px;
            background: #FF3B30; color: white; border-radius: 50%; font-size: 10px;
            display: none; align-items: center; justify-content: center; z-index: 2;
        }
        body.edit-mode .chip-del { display: flex; }
        .add-chip-btn {
            width: 28px; height: 28px; border-radius: 50%; border: 1px dashed #ccc;
            display: flex; align-items: center; justify-content: center; color: #999; font-size: 16px;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; }
        .card {
            background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
            position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; border: 2px solid transparent; transition: 0.1s;
        }
        .card:active { transform: scale(0.98); }
        .card.sel-bf { border-color: var(--bf-color); background: #F0FFF4; }
        .card.sel-lunch { border-color: var(--lunch-color); background: #FFF8F0; }
        .card.sel-dinner { border-color: var(--dinner-color); background: #F4F4FF; }
        .card.sel-both { border-color: var(--primary); background: #F0F8FF; } 
        .card-img { width: 100%; height: 85px; object-fit: cover; background: #eee; }
        .card-body { padding: 10px 6px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .card-name { font-size: 13px; font-weight: 600; line-height: 1.3; margin-bottom: 4px; }
        .badge-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; min-height: 16px;}
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; }
        .bg-bf { background: var(--bf-color); } .bg-lunch { background: var(--lunch-color); }
        .bg-dinner { background: var(--dinner-color); } .bg-prep { background: #8E8E93; }
        .card-edit-btn {
            position: absolute; top: 6px; right: 6px; width: 26px; height: 26px;
            background: rgba(255,255,255,0.9); border-radius: 50%; display: none;
            align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10; font-size: 14px;
        }
        body.edit-mode .card-edit-btn { display: flex; }
        .footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            padding: 12px 20px; border-top: 1px solid #eee; display: flex; gap: 15px; z-index: 200;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        .btn-submit {
            flex: 1; background: var(--text-main); color: white; border: none;
            padding: 14px; border-radius: 25px; font-weight: 600; font-size: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-sheet {
            background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px 20px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15); animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding-bottom: max(25px, env(safe-area-inset-bottom));
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-size: 20px; font-weight: 800; }
        .meal-section {
            background: #F9F9F9; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            border: 2px solid transparent; transition: 0.2s;
        }
        .meal-section.active { border-color: var(--primary); background: #F0F8FF; }
        .meal-section.active-bf { border-color: var(--bf-color); background: #F0FFF4; }
        .meal-checkbox { display: flex; align-items: center; justify-content: space-between; font-weight: 700; font-size: 16px; margin-bottom: 10px; }
        .checkbox-circle {
            width: 22px; height: 22px; border-radius: 50%; border: 2px solid #ccc;
            display: flex; align-items: center; justify-content: center; color: white;
        }
        .meal-section.active .checkbox-circle { background: var(--primary); border-color: var(--primary); }
        .meal-section.active-bf .checkbox-circle { background: var(--bf-color); border-color: var(--bf-color); }
        .detail-box { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .meal-section.active .detail-box, .meal-section.active-bf .detail-box { display: block; }
        .stepper { display: flex; align-items: center; gap: 10px; }
        .step-btn { width: 30px; height: 30px; border-radius: 8px; background: #eee; border: none; font-weight: bold; font-size: 18px;}
        .step-val { font-size: 16px; font-weight: 600; width: 20px; text-align: center;}
        .toggle-row { display: flex; background: #EEE; padding: 3px; border-radius: 8px; margin-bottom: 10px; }
        .toggle-opt {
            flex: 1; text-align: center; padding: 6px; font-size: 13px; font-weight: 600;
            border-radius: 6px; color: #888; transition: 0.2s;
        }
        .toggle-opt.selected { background: white; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: white; }
        .upload-area {
            width: 100%; height: 100px; border: 2px dashed #ccc; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--primary); font-weight: 600; margin-bottom: 15px; background-size: cover; background-position: center;
        }
        .btn-full { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 600; font-size: 15px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #FF3B30; color: white; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ± é˜¿å§¨ç®¡å®¶ V11 (è‡ªåŠ¨ä¿å­˜)</h1>
    <div class="edit-btn" onclick="toggleEditMode()" id="editBtn">âœ ç¼–è¾‘èœå•</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('bf')">æ—©é¤</div>
    <div class="tab" onclick="switchTab('main')">æ­£é¤ç‚¹å• (åˆ/æ™š)</div>
</div>

<div id="tab-bf" class="section active">
    <div id="container-bf"></div>
    <div style="text-align:center; padding:20px; color:var(--primary);" onclick="addCategory('bf')">+ æ·»åŠ æ–°åˆ†ç±»</div>
</div>

<div id="tab-main" class="section">
    <div class="settings-panel">
        <div class="setting-row">
            <div class="setting-label" style="color:var(--lunch-color)">
                <span id="title-lunchPpl">â˜€ï¸ ä¸­é¤äººæ•°</span> <span class="cat-edit-icon" onclick="editTitle('lunchPpl')">âœ</span>
            </div>
            <div class="chip-container" id="chips-lunchPpl"></div>
            <input type="text" class="custom-input" id="input-lunch-extra" placeholder="æƒ³åƒåœŸè±†/çº¢è–¯? (ç›´æ¥å¡«è¿™é‡Œ)" style="margin-top:8px; border:none; background:#F2F2F7;">
        </div>
        <div style="height:1px; background:#eee; margin:10px 0;"></div>
        <div class="setting-row">
            <div class="setting-label" style="color:var(--dinner-color)">
                <span id="title-dinnerRice">ğŸŒ™ æ™šé¤ç±³é¥­</span> <span class="cat-edit-icon" onclick="editTitle('dinnerRice')">âœ</span>
            </div>
            <div class="chip-container" id="chips-dinnerRice"></div>
            <input type="text" class="custom-input" id="input-dinner-extra" placeholder="æƒ³åƒåœŸè±†/çº¢è–¯? (ç›´æ¥å¡«è¿™é‡Œ)" style="margin-top:8px; border:none; background:#F2F2F7;">
        </div>
    </div>
    <div id="container-main"></div>
    <div style="text-align:center; padding:20px; color:var(--primary);" onclick="addCategory('main')">+ æ·»åŠ æ–°åˆ†ç±» (å¦‚: çŒªè‚‰ç±»)</div>
    <div class="cat-header" style="margin-top:30px"><div class="cat-title">ğŸ“ é¢å¤–å¤‡æ³¨</div></div>
    <textarea id="global-note" rows="3" placeholder="ä¾‹å¦‚ï¼šæ”¶å¿«é€’ã€æ‰“æ‰«å«ç”Ÿ..." style="border:none; background:white; padding:15px; border-radius:12px;"></textarea>
</div>

<div class="footer">
    <button class="btn-submit" onclick="generate()">ç”Ÿæˆå¾®ä¿¡æ¶ˆæ¯</button>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-header">
            <div class="sheet-title" id="om-title">èœå“å</div>
            <div style="font-size:24px; color:#ccc;" onclick="closeModal('orderModal')">Ã—</div>
        </div>
        <div id="panel-bf" style="display:none;">
            <div class="meal-section" id="sec-bf" onclick="toggleMeal('bf')">
                <div class="meal-checkbox"><span>â˜€ï¸ æ—©é¤åƒ</span><div class="checkbox-circle" id="chk-bf">âœ“</div></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span>æ•°é‡</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('bf', -1)">-</button><span class="step-val" id="qty-bf">1</span><button class="step-btn" onclick="adjQty('bf', 1)">+</button></div>
                    </div>
                    <input type="text" id="note-bf" placeholder="å¤‡æ³¨ (å¦‚: å°‘ç³–)">
                </div>
            </div>
        </div>
        <div id="panel-main" style="display:none;">
            <div class="meal-section" id="sec-lunch" onclick="toggleMeal('lunch')">
                <div class="meal-checkbox"><span>â˜€ï¸ åˆé¤åƒ</span><div class="checkbox-circle" id="chk-lunch">âœ“</div></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span>ä»½æ•°</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('lunch', -1)">-</button><span class="step-val" id="qty-lunch">1</span><button class="step-btn" onclick="adjQty('lunch', 1)">+</button></div>
                    </div>
                    <input type="text" id="note-lunch" placeholder="å¤‡æ³¨ (å¦‚: å°‘è¾£)">
                </div>
            </div>
            <div class="meal-section" id="sec-dinner" onclick="toggleMeal('dinner')">
                <div class="meal-checkbox"><span>ğŸŒ™ æ™šé¤åƒ</span><div class="checkbox-circle" id="chk-dinner">âœ“</div></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span>ä»½æ•°</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('dinner', -1)">-</button><span class="step-val" id="qty-dinner">1</span><button class="step-btn" onclick="adjQty('dinner', 1)">+</button></div>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-opt selected" id="opt-cook" onclick="setDinnerMode('cook')">ğŸ‘©â€ğŸ³ é˜¿å§¨åšç†Ÿ</div>
                        <div class="toggle-opt" id="opt-prep" onclick="setDinnerMode('prep')">ğŸ”ª å¸®å¿™åˆ‡é…</div>
                    </div>
                    <input type="text" id="note-dinner" placeholder="å¤‡æ³¨ / åˆ‡é…è¯¦æƒ…">
                </div>
            </div>
        </div>
        <button class="btn-full btn-primary" onclick="confirmOrder()">ç¡®å®š</button>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-header"><div class="sheet-title" id="em-title">ç¼–è¾‘èœå“</div><div style="font-size:24px; color:#ccc;" onclick="closeModal('editModal')">Ã—</div></div>
        <label>èœå“åç§°</label><input type="text" id="em-name">
        <label>é»˜è®¤åˆ‡é…/å¤‡æ³¨</label><input type="text" id="em-def-note">
        <label>å›¾ç‰‡</label>
        <label class="upload-area" id="em-preview" for="file-input"><span>ğŸ“· ç‚¹å‡»æ¢å›¾</span></label>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">
        <input type="hidden" id="em-img-data">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-full btn-danger" id="em-btn-del" onclick="deleteDishDb()">åˆ é™¤</button>
            <button class="btn-full btn-primary" onclick="saveDishDb()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-header"><div class="sheet-title">ç”Ÿæˆç»“æœ</div><div style="font-size:24px; color:#ccc;" onclick="closeModal('resultModal')">Ã—</div></div>
        <textarea id="final-text" style="height:250px; margin-bottom:15px;"></textarea>
        <button class="btn-full btn-primary" onclick="copyText()">å¤åˆ¶å†…å®¹</button>
    </div>
</div>

<script>
    // åˆå§‹æ•°æ®
    const initialData = {
        bf: { "ä¸»é£Ÿ": [{n:"ç»¿è±†ç²¥"}, {n:"æ°´ç…®ç‰ç±³", note:"åˆ‡å››æ®µ"}, {n:"æ‚ç²®é¦’å¤´"}], "é¸¡è›‹": [{n:"æ°´ç…®è›‹"}, {n:"è·åŒ…è›‹"}, {n:"ç…é¸¡è›‹"}], "é¥®å“": [{n:"å’–å•¡"}, {n:"è±†æµ†"}, {n:"ç‰›å¥¶"}] },
        main: {
            "é¸¡/é¸­è‚‰ç±»": [{n:"ç™½åˆ‡é¸¡"}, {n:"é’æ¤’é¸¡è…¿"}, {n:"æ¸…ç‚–è€é¸­", prep:"å‘³é“æ·¡çš„è¯è°ƒè˜¸æ–™"}, {n:"å•¤é…’é¸­"}, {n:"æ¤°å­é¸¡"}],
            "ç‰›/ç¾Š/çŒªè‚‰": [{n:"é…¸è¾£åœŸè±†ä¸"}, {n:"ç•ªèŒ„æ´‹è‘±ç‰›è‚‰å·"}, {n:"åœŸè±†ç‚–ç‰›è…©"}, {n:"ç¾Šæ’ç‚–èåœ"}, {n:"å°ç‚’é»„ç‰›è‚‰"}],
            "é±¼/æµ·é²œ": [{n:"è‘±æ²¹é±¼"}, {n:"æ¸…è’¸é±¼"}, {n:"çº¢çƒ§é»„é±¼"}, {n:"ç™½ç¼ç½—æ°è™¾"}, {n:"çº¢çƒ§å¸¦é±¼"}],
            "ç´ èœ/å¤‡èœ": [{n:"ç‚’é’èœ"}, {n:"é†‹æºœåŒ…èœ"}, {n:"æ²¹ç„–ç¬‹", prep:"åˆ‡æˆæ²¹ç„–ç¬‹åšæ³•"}, {n:"å¤§è’œ", prep:"åˆ‡è’œæœ«3ä¸ª"}, {n:"å°è‘±", prep:"åˆ‡ä¸"}, {n:"ä¸ç“œé¸¡è›‹"}]
        },
        options: { lunchPpl: ["2äººå¸¦é¥­", "3äººå¸¦é¥­", "2äººåƒä¸å¸¦"], dinnerRice: ["1äººä»½", "2äººä»½", "3äººä»½", "ä¸ç”¨ç•™"] },
        labels: { lunchPpl: "ä¸­é¤äººæ•°", dinnerRice: "æ™šé¤ç±³é¥­" }
    };

    let data;
    let chips = { lunchPpl: "", dinnerRice: "" };
    let orders = {}; 
    let orderCtx = null; let editCtx = null; 

    // *** è‡ªåŠ¨ä¿å­˜é€»è¾‘ START ***
    function loadData() {
        const saved = localStorage.getItem('myMenuDataV11');
        if (saved) {
            try { data = JSON.parse(saved); } catch(e) { data = JSON.parse(JSON.stringify(initialData)); }
        } else {
            data = JSON.parse(JSON.stringify(initialData));
        }
    }
    function saveData() {
        try { localStorage.setItem('myMenuDataV11', JSON.stringify(data)); } catch(e) { alert("å›¾ç‰‡å¤ªå¤§ï¼Œæ— æ³•ä¿å­˜ï¼Œè¯·ä½¿ç”¨å°ä¸€ç‚¹çš„å›¾ç‰‡"); }
    }
    // *** è‡ªåŠ¨ä¿å­˜é€»è¾‘ END ***

    function init() {
        loadData(); // åŠ è½½æ•°æ®
        renderView();
        renderSettings();
    }

    function renderView() { renderTab('bf', 'container-bf'); renderTab('main', 'container-main'); }

    function renderTab(tab, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const srcData = tab === 'bf' ? data.bf : data.main;
        for(let cat in srcData) {
            const header = document.createElement('div'); header.className = "cat-header";
            header.innerHTML = `<div class="cat-title"><span>${cat}</span><span class="cat-edit-icon" onclick="renameCat('${tab}','${cat}')">âœ</span></div><span class="add-btn-text" onclick="addDishToDb('${tab}','${cat}')">+ æ·»åŠ </span>`;
            container.appendChild(header);
            const grid = document.createElement('div'); grid.className = "grid";
            srcData[cat].forEach((item, idx) => { grid.appendChild(createCard(item, tab, cat, idx)); });
            container.appendChild(grid);
        }
    }

    function createCard(item, tab, cat, idx) {
        const div = document.createElement('div');
        const order = orders[item.n];
        let cls = "card"; let badges = "";
        if(order) {
            if(order.bf && order.bf.active) { cls += " sel-bf"; badges += `<span class="badge bg-bf">æ—©é¤x${order.bf.count}</span>`; }
            if(order.lunch && order.lunch.active) { cls += " sel-lunch"; badges += `<span class="badge bg-lunch">åˆé¤x${order.lunch.count}</span>`; }
            if(order.dinner && order.dinner.active) {
                if(cls.includes("sel-lunch")) cls = "card sel-both"; else cls += " sel-dinner";
                const m = order.dinner.mode === 'prep' ? "ğŸ”ª" : "ğŸŒ™";
                const bg = order.dinner.mode === 'prep' ? "bg-prep" : "bg-dinner";
                badges += `<span class="badge ${bg}">${m}x${order.dinner.count}</span>`;
            }
        }
        const imgUrl = item.img || getAutoImg(item.n);
        div.className = cls;
        div.innerHTML = `<div class="card-edit-btn" onclick="event.stopPropagation(); editDishDb('${tab}','${cat}',${idx})">âœ</div><img src="${imgUrl}" class="card-img"><div class="card-body"><div class="card-name">${item.n}</div><div class="badge-container">${badges}</div></div>`;
        div.onclick = () => { if(document.body.classList.contains('edit-mode')) return; openOrderModal(item, tab); };
        return div;
    }

    function openOrderModal(item, tab) {
        orderCtx = { item, tab };
        const order = orders[item.n] || {};
        document.getElementById('om-title').innerText = item.n;
        const pBf = document.getElementById('panel-bf');
        const pMain = document.getElementById('panel-main');
        
        if(tab === 'bf') {
            pBf.style.display = 'block'; pMain.style.display = 'none';
            const active = order.bf && order.bf.active;
            toggleMealUI('bf', active);
            document.getElementById('qty-bf').innerText = (order.bf && order.bf.count) || 1;
            document.getElementById('note-bf').value = (order.bf && order.bf.note) || (item.note || "");
            if(!active) toggleMealUI('bf', true);
        } else {
            pBf.style.display = 'none'; pMain.style.display = 'block';
            toggleMealUI('lunch', order.lunch && order.lunch.active);
            document.getElementById('qty-lunch').innerText = (order.lunch && order.lunch.count) || 1;
            document.getElementById('note-lunch').value = (order.lunch && order.lunch.note) || "";
            toggleMealUI('dinner', order.dinner && order.dinner.active);
            document.getElementById('qty-dinner').innerText = (order.dinner && order.dinner.count) || 1;
            setDinnerMode((order.dinner && order.dinner.mode) || 'cook');
            let dNote = (order.dinner && order.dinner.note) || "";
            if(!dNote && item.prep) dNote = item.prep;
            document.getElementById('note-dinner').value = dNote;
        }
        openModal('orderModal');
    }
    function toggleMeal(m) { 
        const c = m==='bf'?'active-bf':'active';
        const el = document.getElementById('sec-'+m);
        toggleMealUI(m, !el.classList.contains(c)); 
    }
    function toggleMealUI(m, active) {
        const c = m==='bf'?'active-bf':'active';
        const el = document.getElementById('sec-'+m);
        const chk = document.getElementById('chk-'+m);
        if(active) { el.classList.add(c); chk.innerText = "âœ“"; } else { el.classList.remove(c); chk.innerText = ""; }
    }
    function adjQty(m, d) {
        const el = document.getElementById('qty-'+m);
        let v = parseInt(el.innerText) + d; if(v<1) v=1; el.innerText = v;
    }
    function setDinnerMode(m) {
        document.getElementById('opt-cook').className = m==='cook'?'toggle-opt selected':'toggle-opt';
        document.getElementById('opt-prep').className = m==='prep'?'toggle-opt selected':'toggle-opt';
        document.getElementById('sec-dinner').dataset.mode = m;
    }
    function confirmOrder() {
        const item = orderCtx.item;
        if(!orders[item.n]) orders[item.n] = {};
        if(orderCtx.tab === 'bf') {
            if(document.getElementById('sec-bf').classList.contains('active-bf')) {
                orders[item.n].bf = { active:true, count:parseInt(document.getElementById('qty-bf').innerText), note:document.getElementById('note-bf').value };
            } else delete orders[item.n].bf;
        } else {
            if(document.getElementById('sec-lunch').classList.contains('active')) {
                orders[item.n].lunch = { active:true, count:parseInt(document.getElementById('qty-lunch').innerText), note:document.getElementById('note-lunch').value };
            } else delete orders[item.n].lunch;
            if(document.getElementById('sec-dinner').classList.contains('active')) {
                orders[item.n].dinner = { active:true, count:parseInt(document.getElementById('qty-dinner').innerText), mode:document.getElementById('sec-dinner').dataset.mode, note:document.getElementById('note-dinner').value };
            } else delete orders[item.n].dinner;
        }
        if(Object.keys(orders[item.n]).length===0) delete orders[item.n];
        closeModal('orderModal'); renderView();
    }

    // ç¼–è¾‘
    function toggleEditMode() { document.body.classList.toggle('edit-mode'); document.getElementById('editBtn').classList.toggle('active'); }
    function editDishDb(tab, cat, idx) {
        editCtx = { tab, cat, idx, isNew: false };
        const item = (tab==='bf'?data.bf:data.main)[cat][idx];
        document.getElementById('em-title').innerText = "ç¼–è¾‘èœå“";
        document.getElementById('em-name').value = item.n;
        document.getElementById('em-def-note').value = item.prep || item.note || "";
        const bg = item.img ? `url(${item.img})` : "none";
        document.getElementById('em-preview').style.backgroundImage = bg;
        document.getElementById('em-img-data').value = item.img || "";
        document.getElementById('em-btn-del').style.display = 'block';
        openModal('editModal');
    }
    function addDishToDb(tab, cat) {
        editCtx = { tab, cat, idx: -1, isNew: true };
        document.getElementById('em-title').innerText = "æ·»åŠ æ–°èœ";
        document.getElementById('em-name').value = "";
        document.getElementById('em-def-note').value = "";
        document.getElementById('em-preview').style.backgroundImage = "none";
        document.getElementById('em-img-data').value = "";
        document.getElementById('em-btn-del').style.display = 'none';
        openModal('editModal');
    }
    function handleFile(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => {
                document.getElementById('em-preview').style.backgroundImage = `url(${e.target.result})`;
                document.getElementById('em-img-data').value = e.target.result;
            }
            r.readAsDataURL(input.files[0]);
        }
    }
    function saveDishDb() {
        const name = document.getElementById('em-name').value; if(!name) return;
        const newItem = { n: name, img: document.getElementById('em-img-data').value, prep: document.getElementById('em-def-note').value };
        newItem.note = newItem.prep;
        const list = (editCtx.tab==='bf'?data.bf:data.main)[editCtx.cat];
        if(editCtx.isNew) list.push(newItem); else list[editCtx.idx] = newItem;
        saveData(); // SAVE
        closeModal('editModal'); renderView();
    }
    function deleteDishDb() {
        if(confirm("åˆ é™¤ï¼Ÿ")) {
            (editCtx.tab==='bf'?data.bf:data.main)[editCtx.cat].splice(editCtx.idx, 1);
            delete orders[document.getElementById('em-name').value];
            saveData(); // SAVE
            closeModal('editModal'); renderView();
        }
    }
    function renameCat(tab, old) {
        const n = prompt("ä¿®æ”¹åˆ†ç±»å", old); const db = tab==='bf'?data.bf:data.main;
        if(n && n!==old) { db[n] = db[old]; delete db[old]; saveData(); renderView(); }
    }
    function addCategory(tab) {
        const n = prompt("æ–°åˆ†ç±»åç§°"); const db = tab==='bf'?data.bf:data.main;
        if(n) { db[n] = []; saveData(); renderView(); }
    }
    // Settings
    function renderSettings() {
        document.getElementById('title-lunchPpl').innerText = data.labels.lunchPpl; renderChips('chips-lunchPpl', data.options.lunchPpl, 'lunchPpl');
        document.getElementById('title-dinnerRice').innerText = data.labels.dinnerRice; renderChips('chips-dinnerRice', data.options.dinnerRice, 'dinnerRice');
    }
    function renderChips(id, list, key) {
        const el = document.getElementById(id); el.innerHTML = "";
        list.forEach((txt, i) => {
            const c = document.createElement('div'); c.className = `chip ${chips[key]===txt?(key==='lunchPpl'?'lunch-active':'dinner-active'):''}`;
            c.innerHTML = `${txt} <div class="chip-del" onclick="event.stopPropagation();delChip('${key}',${i})">Ã—</div>`;
            c.onclick = () => { if(document.body.classList.contains('edit-mode')) return; chips[key] = chips[key]===txt?"":txt; renderSettings(); };
            el.appendChild(c);
        });
        const add = document.createElement('div'); add.className="add-chip-btn"; add.innerText="+";
        add.onclick = () => { const v=prompt("æ·»åŠ é€‰é¡¹"); if(v) { data.options[key].push(v); saveData(); renderSettings(); } };
        el.appendChild(add);
    }
    function delChip(k,i) { data.options[k].splice(i,1); saveData(); renderSettings(); }
    function editTitle(k) { const v=prompt("ä¿®æ”¹æ ‡é¢˜",data.labels[k]); if(v) { data.labels[k]=v; saveData(); renderSettings(); } }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab')[t==='bf'?0:1].classList.add('active');
        document.getElementById('tab-'+t).classList.add('active');
    }
    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    function getAutoImg(name) {
        const k={"é¸¡":"chicken","é¸­":"duck","ç‰›":"beef","ç¾Š":"lamb","é±¼":"fish","è™¾":"shrimp","ç²¥":"porridge","è›‹":"egg","èœ":"vegetable","å¥¶":"milk","å’–":"coffee","é¢":"noodle","é¥­":"rice","ç¬‹":"bamboo"};
        let kw="food"; for(let key in k) if(name.includes(key)) kw=k[key];
        let h=0; for(let i=0;i<name.length;i++) h+=name.charCodeAt(i);
        return `https://loremflickr.com/150/150/${kw}/all?lock=${h}`;
    }
    function generate() {
        let msg = "é˜¿å§¨ï¼Œæ˜å¤©é¥­èœå®‰æ’ï¼š\n";
        let bf = [];
        for(let k in orders) {
            if(orders[k].bf && orders[k].bf.active) {
                let s = k; if(orders[k].bf.count>1) s+=` x${orders[k].bf.count}`; if(orders[k].bf.note) s+=` (${orders[k].bf.note})`; bf.push(s);
            }
        }
        if(bf.length) msg += `\nâ˜€ï¸ã€æ—©é¤ã€‘\n${bf.join('ï¼Œ')}`;
        
        let lunch = [];
        for(let k in orders) {
            if(orders[k].lunch && orders[k].lunch.active) {
                let s = k; if(orders[k].lunch.count>1) s+=` x${orders[k].lunch.count}`; if(orders[k].lunch.note) s+=` (${orders[k].lunch.note})`; lunch.push(s);
            }
        }
        const lE = document.getElementById('input-lunch-extra').value;
        if(lunch.length||chips.lunchPpl||lE) {
            msg += `\n\nğŸ±ã€ä¸­é¤ã€‘`; if(chips.lunchPpl) msg+=`\näººæ•°ï¼š${chips.lunchPpl}`; if(lE) msg+=`\nè¡¥å……ï¼š${lE}`; if(lunch.length) msg+=`\nèœå“ï¼š${lunch.join('ï¼Œ')}`;
        }
        
        let dCook=[], dPrep=[];
        for(let k in orders) {
            if(orders[k].dinner && orders[k].dinner.active) {
                const d = orders[k].dinner;
                let s = k; if(d.count>1) s+=` x${d.count}`;
                if(d.mode==='prep') dPrep.push(`${s} (è¦æ±‚: ${d.note||"å¸¸è§„"})`);
                else { if(d.note) s+=` (${d.note})`; dCook.push(s); }
            }
        }
        const dE = document.getElementById('input-dinner-extra').value;
        if(dCook.length||dPrep.length||chips.dinnerRice||dE) {
            msg+=`\n\nğŸŒ™ã€æ™šé¤/å¤‡èœã€‘`; if(chips.dinnerRice) msg+=`\nç±³é¥­ï¼š${chips.dinnerRice}`; if(dE) msg+=`\nè¡¥å……ï¼š${dE}`;
            if(dPrep.length) msg+=`\nğŸ”ª éœ€åˆ‡é…ï¼š\n- ${dPrep.join('\n- ')}`;
            if(dCook.length) msg+=`\nğŸ‘©â€ğŸ³ éœ€åšç†Ÿï¼š\n- ${dCook.join('\n- ')}`;
        }
        const gn = document.getElementById('global-note').value; if(gn) msg+=`\n\nğŸ“ã€å¤‡æ³¨ã€‘\n${gn}`;
        msg+="\n\nè¾›è‹¦é˜¿å§¨äº†ï¼";
        document.getElementById('final-text').value=msg; openModal('resultModal');
    }
    function copyText() { document.getElementById('final-text').select(); document.execCommand('copy'); alert("å¤åˆ¶æˆåŠŸ"); }
    init();
</script>
</body>
</html>