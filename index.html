<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿å§¨ç®¡å®¶ V18 (é¡ºæ»‘äº¤äº’ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; --lunch-color: #FF9500; --dinner-color: #5856D6;
            --bf-color: #34C759; --bg: #F2F2F7; --card-bg: #FFFFFF;
            --text-main: #1C1C1E; --text-sub: #8E8E93; --radius: 12px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            background-color: var(--bg); color: var(--text-main); margin: 0;
            padding-bottom: 120px; 
            -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 12px 20px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header h1 { margin: 0; font-size: 18px; font-weight: 800; }
        .action-btn {
            font-size: 14px; color: var(--primary); background: rgba(0,122,255,0.1);
            padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .action-btn.saving-mode { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }

        /* æ ‡ç­¾é¡µ */
        .tabs { display: flex; background: var(--card-bg); padding: 4px; margin: 10px 15px; border-radius: 14px; }
        .tab { flex: 1; text-align: center; padding: 8px 0; font-size: 14px; font-weight: 600; color: var(--text-sub); border-radius: 10px; }
        .tab.active { background: #E4EBF5; color: var(--primary); }

        .section { display: none; padding: 0 15px; }
        .section.active { display: block; }

        /* åˆ†ç±»å®¹å™¨ */
        .cat-wrapper { margin-bottom: 15px; background: transparent; border-radius: 12px; transition: 0.2s; }
        body.edit-mode .cat-wrapper { background: rgba(255,255,255,0.5); padding: 10px; border: 1px dashed #ccc; }

        .cat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; }
        .cat-title { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .cat-title::before { content:''; width:4px; height:16px; background:var(--primary); border-radius:2px; }
        
        .tools { display: none; align-items: center; gap: 10px; }
        body.edit-mode .tools { display: flex; }
        .icon-btn { font-size: 14px; color: var(--text-sub); padding: 4px; }
        
        .drag-handle {
            font-size: 22px; color: var(--text-main); cursor: grab; padding: 0 10px;
            touch-action: none;
        }

        /* èœå“ç½‘æ ¼ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; min-height: 10px; }

        .card {
            background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
            position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; 
            -webkit-touch-callout: none; transition: transform 0.2s;
        }
        .card:active { transform: scale(0.97); }
        .card.sel-bf { border-color: var(--bf-color); background: #F0FFF4; }
        .card.sel-lunch { border-color: var(--lunch-color); background: #FFF8F0; }
        .card.sel-dinner { border-color: var(--dinner-color); background: #F4F4FF; }
        .card.sel-both { border-color: var(--primary); background: #F0F8FF; }

        .sortable-ghost { opacity: 0.4; background: #ddd; }
        .sortable-drag { transform: scale(1.05); z-index: 999; opacity: 0.9; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .card-img { width: 100%; height: 85px; object-fit: cover; background: #eee; pointer-events: none; }
        .card-body { padding: 10px 6px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; pointer-events: none; }
        .card-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin: 1px;}
        .bg-bf { background: var(--bf-color); } .bg-lunch { background: var(--lunch-color); }
        .bg-dinner { background: var(--dinner-color); } .bg-prep { background: #8E8E93; }

        /* ç¼–è¾‘é®ç½© */
        .card-mask {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.8); z-index: 10; display: none;
            align-items: center; justify-content: center;
        }
        body.edit-mode .card-mask { display: flex; }
        .mini-btn { font-size: 12px; padding: 6px 12px; border-radius: 15px; border: 1px solid #ccc; background: white; font-weight: bold; }

        /* åº•éƒ¨æ  */
        .footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            padding: 12px 20px; border-top: 1px solid #eee; z-index: 200;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        .btn-submit {
            width: 100%; background: var(--text-main); color: white; border: none;
            padding: 14px; border-radius: 25px; font-weight: 600; font-size: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        /* å¼¹çª—é€šç”¨ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-sheet {
            background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15); animation: slideUp 0.2s ease-out;
            padding-bottom: max(25px, env(safe-area-inset-bottom)); max-height: 85vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; background: #F9F9F9; font-size: 16px; margin-bottom: 10px; }
        .btn-full { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 600; font-size: 15px; cursor: pointer; margin-top: 5px;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #FF3B30; color: white; }
        .btn-secondary { background: #E5E5EA; color: #000; } /* æ–°å¢ç°è‰²æŒ‰é’® */
        
        .upload-area {
            width: 100%; height: 100px; border: 2px dashed #ccc; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: #999; font-weight: 600; margin-bottom: 15px; background-size: contain; background-repeat: no-repeat; background-position: center;
        }

        /* ç‚¹é¤è¯¦æƒ…åŒº */
        .meal-section { background: #F9F9F9; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 2px solid transparent; transition: 0.2s; }
        .meal-section.active { border-color: var(--primary); background: #F0F8FF; }
        .meal-section.active-bf { border-color: var(--bf-color); background: #F0FFF4; }
        
        .meal-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 16px; }
        .detail-box { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.05); }
        .meal-section.active .detail-box, .meal-section.active-bf .detail-box { display: block; }

        .stepper { display: flex; gap: 15px; align-items: center; }
        .step-btn { width: 32px; height: 32px; background: white; border: 1px solid #ddd; border-radius: 50%; font-weight: bold; font-size: 18px; display:flex; align-items:center; justify-content:center;}
        .toggle-row { display: flex; background: #EEE; padding: 3px; border-radius: 8px; margin-bottom: 10px; }
        .toggle-opt { flex: 1; text-align: center; padding: 8px; font-size: 13px; border-radius: 6px; color: #888; }
        .toggle-opt.selected { background: white; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* è®¾ç½®é¢æ¿ */
        .settings-panel { background: var(--card-bg); padding: 15px; border-radius: var(--radius); margin-bottom: 15px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
        .chip { padding: 6px 12px; background: #F2F2F7; border-radius: 18px; font-size: 13px; position: relative; }
        .chip.lunch-active { background: var(--lunch-color); color: white; }
        .chip.dinner-active { background: var(--dinner-color); color: white; }
        .chip-del { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #FF3B30; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold;}
        body.edit-mode .chip-del { display: flex; }

        /* V18 æ–°å¢ï¼šç»“æœé¡µæŒ‰é’®ç»„ */
        .action-group { display: flex; gap: 15px; margin-top: 10px; }
        .action-group .btn-full { margin-top: 0; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ± é˜¿å§¨ç®¡å®¶ V18</h1>
    <div class="action-btn" id="mainActionBtn" onclick="toggleEditMode()">âœ ç¼–è¾‘ / æ’åº</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('bf')">æ—©é¤</div>
    <div class="tab" onclick="switchTab('main')">æ­£é¤ (åˆ/æ™š)</div>
</div>

<div id="tab-bf" class="section active">
    <div id="container-bf"></div>
    <button class="btn-full btn-primary" id="add-cat-bf" style="display:none; margin-top:20px;" onclick="addCategory('bf')">+ æ–°å¢æ—©é¤åˆ†ç±»</button>
</div>

<div id="tab-main" class="section">
    <div class="settings-panel">
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:700;">â˜€ï¸ ä¸­é¤äººæ•°</span>
            <span class="tools icon-btn" onclick="editLabel('lunchPpl')">é‡å‘½å</span>
        </div>
        <div class="chip-container" id="chips-lunchPpl"></div>
        <input type="text" id="input-lunch-extra" placeholder="å¤‡æ³¨ (åœŸè±†/çº¢è–¯ç­‰)" style="margin-top:10px; border:none; border-bottom:1px solid #eee; background:transparent;">
        
        <div style="height:20px;"></div>
        
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:700;">ğŸŒ™ æ™šé¤ç±³é¥­</span>
            <span class="tools icon-btn" onclick="editLabel('dinnerRice')">é‡å‘½å</span>
        </div>
        <div class="chip-container" id="chips-dinnerRice"></div>
        <input type="text" id="input-dinner-extra" placeholder="å¤‡æ³¨ (åœŸè±†/çº¢è–¯ç­‰)" style="margin-top:10px; border:none; border-bottom:1px solid #eee; background:transparent;">
    </div>

    <div id="container-main"></div>
    <button class="btn-full btn-primary" id="add-cat-main" style="display:none; margin-top:20px;" onclick="addCategory('main')">+ æ–°å¢æ­£é¤åˆ†ç±»</button>
    
    <div class="cat-wrapper" style="margin-top:20px;">
        <div class="cat-title">ğŸ“ é¢å¤–å¤‡æ³¨</div>
        <textarea id="global-note" rows="3" placeholder="ä¾‹å¦‚ï¼šæ”¶å¿«é€’ã€æ‰“æ‰«å«ç”Ÿ..." style="margin-top:10px;"></textarea>
    </div>
</div>

<div class="footer">
    <button class="btn-submit" onclick="generate()">ç”Ÿæˆå¾®ä¿¡æ¶ˆæ¯</button>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span class="sheet-title" id="om-title"></span>
            <span style="font-size:24px;color:#ccc" onclick="closeModal('orderModal')">Ã—</span>
        </div>

        <div id="panel-bf" style="display:none;">
            <div class="meal-section" id="sec-bf" onclick="toggleMeal('bf')">
                <div class="meal-header"><span>â˜€ï¸ æ—©é¤åƒ</span><span id="chk-bf"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold;">æ•°é‡</span>
                        <div class="stepper">
                            <button class="step-btn" onclick="adjQty('bf',-1)">-</button>
                            <span id="qty-bf" style="font-weight:bold; font-size:18px; width:20px; text-align:center;">1</span>
                            <button class="step-btn" onclick="adjQty('bf',1)">+</button>
                        </div>
                    </div>
                    <input type="text" id="note-bf" placeholder="å¤‡æ³¨ (å¦‚: å°‘ç³–)">
                </div>
            </div>
        </div>

        <div id="panel-main" style="display:none;">
            <div class="meal-section" id="sec-lunch" onclick="toggleMeal('lunch')">
                <div class="meal-header"><span>â˜€ï¸ åˆé¤åƒ</span><span id="chk-lunch"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold;">ä»½æ•°</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('lunch',-1)">-</button><span id="qty-lunch" style="font-weight:bold; font-size:18px;">1</span><button class="step-btn" onclick="adjQty('lunch',1)">+</button></div>
                    </div>
                    <input type="text" id="note-lunch" placeholder="å¤‡æ³¨ (å¦‚: å°‘è¾£)">
                </div>
            </div>
            <div class="meal-section" id="sec-dinner" onclick="toggleMeal('dinner')">
                <div class="meal-header"><span>ğŸŒ™ æ™šé¤åƒ</span><span id="chk-dinner"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold;">ä»½æ•°</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('dinner',-1)">-</button><span id="qty-dinner" style="font-weight:bold; font-size:18px;">1</span><button class="step-btn" onclick="adjQty('dinner',1)">+</button></div>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-opt selected" id="opt-cook" onclick="setDinnerMode('cook')">ğŸ‘©â€ğŸ³ é˜¿å§¨åšç†Ÿ</div>
                        <div class="toggle-opt" id="opt-prep" onclick="setDinnerMode('prep')">ğŸ”ª å¸®å¿™åˆ‡é…</div>
                    </div>
                    <input type="text" id="note-dinner" placeholder="å¤‡æ³¨ / åˆ‡é…è¯¦æƒ…">
                </div>
            </div>
        </div>
        <button class="btn-full btn-primary" onclick="confirmOrder()">ç¡®å®š</button>
    </div>
</div>

<div id="dishModal" class="modal-overlay">
    <div class="modal-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span class="sheet-title" id="dm-title"></span>
            <span style="font-size:24px;color:#ccc" onclick="closeModal('dishModal')">Ã—</span>
        </div>
        <label>èœå“åç§°</label><input type="text" id="dm-name">
        <label>é»˜è®¤åˆ‡é…/å¤‡æ³¨</label><input type="text" id="dm-prep">
        <label>å›¾ç‰‡ (è‡ªåŠ¨å‹ç¼©)</label>
        <label class="upload-area" id="dm-preview" for="file-input"><span>ğŸ“· ç‚¹å‡»ä¸Šä¼ </span></label>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">
        <input type="hidden" id="dm-img-data">
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-full btn-danger" id="dm-btn-del" onclick="deleteDish()">åˆ é™¤</button>
            <button class="btn-full btn-primary" onclick="saveDishTemp()">ç¡®å®š</button>
        </div>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-title" style="margin-bottom:15px;">ç”Ÿæˆç»“æœ</div>
        <textarea id="final-text" style="height:200px;"></textarea>
        
        <div class="action-group">
            <button class="btn-full btn-secondary" onclick="closeModal('resultModal')">ğŸ”™ è¿”å›ä¿®æ”¹</button>
            <button class="btn-full btn-primary" id="btn-copy" onclick="copyText()">ğŸ“„ å¤åˆ¶å†…å®¹</button>
        </div>
    </div>
</div>

<script>
    // --- 1. æ•°æ®æ ¸å¿ƒ ---
    const defaultData = {
        bf: { "ä¸»é£Ÿ": [{n:"ç»¿è±†ç²¥"}, {n:"ç‰ç±³"}], "é¸¡è›‹": [{n:"æ°´ç…®è›‹"}], "é¥®å“": [{n:"ç‰›å¥¶"}] },
        main: { "è‚‰ç±»": [{n:"çº¢çƒ§è‚‰"}], "ç´ èœ": [{n:"ç‚’é’èœ"}] },
        options: { lunchPpl: ["2äºº", "3äºº"], dinnerRice: ["1äººä»½", "ä¸ç”¨"] },
        labels: { lunchPpl: "ä¸­é¤äººæ•°", dinnerRice: "æ™šé¤ç±³é¥­" }
    };
    let data = {}; let orders = {}; 
    let orderCtx=null; let editCtx=null;
    let tmpL = ""; let tmpD = ""; 

    // --- 2. åˆå§‹åŒ– ---
    function init() {
        const saved = localStorage.getItem('aygj_v18');
        if(saved) {
            try { data = JSON.parse(saved); } catch(e) { data = JSON.parse(JSON.stringify(defaultData)); }
        } else {
            data = JSON.parse(JSON.stringify(defaultData));
        }
        if(!data.bf) data.bf = {};
        if(!data.main) data.main = {};
        renderAll();
    }

    // --- 3. æ¨¡å¼åˆ‡æ¢ & ä¿å­˜ ---
    function toggleEditMode() {
        const body = document.body;
        const btn = document.getElementById('mainActionBtn');
        
        if (body.classList.contains('edit-mode')) {
            try {
                localStorage.setItem('aygj_v18', JSON.stringify(data));
                alert("âœ… ä¿®æ”¹å·²ä¿å­˜ï¼");
            } catch(e) { alert("ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡å¤ªå¤šäº†ã€‚"); }
            
            body.classList.remove('edit-mode');
            btn.innerText = "âœ ç¼–è¾‘ / æ’åº";
            btn.classList.remove('saving-mode');
            document.getElementById('add-cat-bf').style.display = 'none';
            document.getElementById('add-cat-main').style.display = 'none';
            renderAll(); 
        } else {
            body.classList.add('edit-mode');
            btn.innerText = "ğŸ’¾ ä¿å­˜ä¿®æ”¹";
            btn.classList.add('saving-mode');
            document.getElementById('add-cat-bf').style.display = 'block';
            document.getElementById('add-cat-main').style.display = 'block';
            renderAll(); 
        }
    }

    // --- 4. æ¸²æŸ“ç³»ç»Ÿ ---
    function renderAll() {
        renderTab('bf', 'container-bf');
        renderTab('main', 'container-main');
        renderSettings();
    }

    function renderTab(tab, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const isEdit = document.body.classList.contains('edit-mode');
        const db = data[tab];

        for (let cat in db) {
            const wrapper = document.createElement('div');
            wrapper.className = "cat-wrapper";
            wrapper.dataset.cat = cat; 

            const header = document.createElement('div');
            header.className = "cat-header";
            header.innerHTML = `
                <div class="cat-title">
                    <span>${cat}</span> 
                    <span class="tools">
                        <span class="icon-btn" onclick="renameCat('${tab}','${cat}')">âœ</span>
                        <span class="icon-btn" style="color:#FF3B30" onclick="delCat('${tab}','${cat}')">ğŸ—‘</span>
                    </span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="tools icon-btn" style="color:var(--primary);font-weight:bold;" onclick="openDishModal('${tab}','${cat}',-1)">+ åŠ èœ</span>
                    ${isEdit ? '<span class="drag-handle">â‰¡</span>' : ''}
                </div>
            `;
            
            const grid = document.createElement('div');
            grid.className = "grid";
            
            db[cat].forEach((item, idx) => {
                grid.appendChild(createCard(item, tab, cat, idx));
            });

            wrapper.appendChild(header);
            wrapper.appendChild(grid);
            container.appendChild(wrapper);

            if (isEdit) {
                new Sortable(grid, {
                    animation: 150,
                    delay: 200, delayOnTouchOnly: true,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: (evt) => {
                        const itemData = data[tab][cat].splice(evt.oldIndex, 1)[0];
                        data[tab][cat].splice(evt.newIndex, 0, itemData);
                    }
                });
            }
        }

        if (isEdit) {
            new Sortable(container, {
                animation: 150,
                handle: '.drag-handle', 
                onEnd: (evt) => {
                    const newDb = {};
                    container.querySelectorAll('.cat-wrapper').forEach(w => {
                        newDb[w.dataset.cat] = data[tab][w.dataset.cat];
                    });
                    data[tab] = newDb;
                }
            });
        }
    }

    function createCard(item, tab, cat, idx) {
        const div = document.createElement('div');
        const order = orders[item.n];
        let cls = "card"; let badges = "";
        if(order) {
            if(order.bf?.active) { cls+=" sel-bf"; badges+=`<span class="badge bg-bf">æ—©${order.bf.count>1?'x'+order.bf.count:''}</span>`; }
            if(order.lunch?.active) { cls+=" sel-lunch"; badges+=`<span class="badge bg-lunch">åˆ${order.lunch.count>1?'x'+order.lunch.count:''}</span>`; }
            if(order.dinner?.active) { 
                if(cls.includes("sel-lunch")) cls="card sel-both"; else cls+=" sel-dinner";
                badges+=`<span class="badge ${order.dinner.mode==='prep'?'bg-prep':'bg-dinner'}">${order.dinner.mode==='prep'?'åˆ‡':'æ™š'}${order.dinner.count>1?'x'+order.dinner.count:''}</span>`;
            }
        }
        
        const imgUrl = item.img || `https://via.placeholder.com/150?text=${item.n[0]}`;
        div.className = cls;
        div.innerHTML = `
            <img src="${imgUrl}" class="card-img">
            <div class="card-body"><div class="card-name">${item.n}</div><div>${badges}</div></div>
            <div class="card-mask">
                <div class="mini-btn" onclick="event.stopPropagation();openDishModal('${tab}','${cat}',${idx})">âœ ä¿®æ”¹</div>
            </div>
        `;
        div.onclick = () => { if(!document.body.classList.contains('edit-mode')) openOrderModal(item, tab); };
        return div;
    }

    // --- 5. ä¸šåŠ¡é€»è¾‘ï¼šå¤§ç±»ç®¡ç† ---
    function addCategory(tab) {
        const n = prompt("æ–°åˆ†ç±»åç§°");
        if(n) {
            if(!data[tab]) data[tab] = {};
            if(data[tab][n]) { alert("åç§°å·²å­˜åœ¨"); return; }
            data[tab][n] = []; 
            renderAll();
        }
    }
    function renameCat(tab, old) {
        const n = prompt("ä¿®æ”¹åç§°", old);
        if(n && n!==old && !data[tab][n]) {
            const items = data[tab][old];
            delete data[tab][old];
            data[tab][n] = items;
            renderAll();
        }
    }
    function delCat(tab, cat) {
        if(confirm(`åˆ é™¤åˆ†ç±»ã€${cat}ã€‘ï¼Ÿ`)) { delete data[tab][cat]; renderAll(); }
    }

    // --- 6. ä¸šåŠ¡é€»è¾‘ï¼šèœå“ç¼–è¾‘ ---
    function openDishModal(tab, cat, idx) {
        editCtx = { tab, cat, idx, isNew: idx===-1 };
        const item = idx===-1 ? {n:"", prep:""} : data[tab][cat][idx];
        document.getElementById('dm-title').innerText = editCtx.isNew ? "æ·»åŠ èœå“" : "ä¿®æ”¹èœå“";
        document.getElementById('dm-name').value = item.n;
        document.getElementById('dm-prep').value = item.prep || "";
        document.getElementById('dm-preview').style.backgroundImage = item.img ? `url(${item.img})` : "none";
        document.getElementById('dm-img-data').value = item.img || "";
        document.getElementById('dm-btn-del').style.display = editCtx.isNew ? 'none' : 'block';
        document.getElementById('dishModal').classList.add('show');
    }
    function handleFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const scale = 300/img.width;
                    cvs.width=300; cvs.height=img.height*scale;
                    cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                    const zip = cvs.toDataURL('image/jpeg', 0.7);
                    document.getElementById('dm-preview').style.backgroundImage = `url(${zip})`;
                    document.getElementById('dm-img-data').value = zip;
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    function saveDishTemp() {
        const n = document.getElementById('dm-name').value; if(!n) return;
        const item = { n, img: document.getElementById('dm-img-data').value, prep: document.getElementById('dm-prep').value };
        if(editCtx.isNew) data[editCtx.tab][editCtx.cat].push(item);
        else data[editCtx.tab][editCtx.cat][editCtx.idx] = item;
        closeModal('dishModal'); renderAll();
    }
    function deleteDish() {
        if(confirm("åˆ é™¤ï¼Ÿ")) {
            data[editCtx.tab][editCtx.cat].splice(editCtx.idx, 1);
            delete orders[document.getElementById('dm-name').value];
            closeModal('dishModal'); renderAll();
        }
    }

    // --- 7. ä¸šåŠ¡é€»è¾‘ï¼šç‚¹é¤ ---
    function openOrderModal(item, tab) {
        orderCtx = { item, tab };
        const order = orders[item.n] || {};
        document.getElementById('om-title').innerText = item.n;
        
        document.getElementById('panel-bf').style.display = tab==='bf'?'block':'none';
        document.getElementById('panel-main').style.display = tab==='main'?'block':'none';
        
        document.getElementById('note-bf').value = "";
        document.getElementById('note-lunch').value = "";
        document.getElementById('note-dinner').value = "";

        if(tab === 'bf') {
            updateUI('bf', order.bf);
            if (!order.bf || !order.bf.active) { toggleMeal('bf'); }
        } else {
            updateUI('lunch', order.lunch);
            updateUI('dinner', order.dinner);
            setDinnerMode(order.dinner?.mode||'cook', false);
            if(order.dinner?.note) document.getElementById('note-dinner').value = order.dinner.note;
            else if(order.dinner?.mode==='prep') document.getElementById('note-dinner').value = item.prep||"";
        }
        document.getElementById('orderModal').classList.add('show');
    }

    function toggleMeal(t) {
        const sec = document.getElementById(t==='bf'?'sec-bf':(t==='lunch'?'sec-lunch':'sec-dinner'));
        const chk = document.getElementById(t==='bf'?'chk-bf':(t==='lunch'?'chk-lunch':'chk-dinner'));
        const cls = t==='bf'?'active-bf':'active';
        
        sec.classList.toggle(cls);
        
        if(sec.classList.contains(cls)) {
            chk.innerHTML = "âœ“";
            const qtyId = t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner');
            if(document.getElementById(qtyId).innerText === "0") document.getElementById(qtyId).innerText = "1";
        } else {
            chk.innerHTML = "";
        }
    }

    function updateUI(t, d) {
        const sec = document.getElementById(t==='bf'?'sec-bf':(t==='lunch'?'sec-lunch':'sec-dinner'));
        const chk = document.getElementById(t==='bf'?'chk-bf':(t==='lunch'?'chk-lunch':'chk-dinner'));
        const qty = document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner'));
        const note = document.getElementById(t==='bf'?'note-bf':(t==='lunch'?'note-lunch':'note-dinner'));
        const cls = t==='bf'?'active-bf':'active';

        if(d && d.active) {
            sec.classList.add(cls);
            chk.innerHTML = "âœ“";
            qty.innerText = d.count;
            if(t!=='dinner') note.value = d.note || "";
        } else {
            sec.classList.remove(cls);
            chk.innerHTML = "";
            qty.innerText = "1";
        }
    }

    function confirmOrder() {
        const item = orderCtx.item;
        if(!orders[item.n]) orders[item.n] = {};
        
        if(orderCtx.tab === 'bf') {
            if(document.getElementById('sec-bf').classList.contains('active-bf')) {
                orders[item.n].bf = { active:true, count:getQty('bf'), note:getVal('note-bf') };
            } else {
                delete orders[item.n].bf;
            }
        } else {
            if(document.getElementById('sec-lunch').classList.contains('active')) {
                orders[item.n].lunch = { active:true, count:getQty('lunch'), note:getVal('note-lunch') };
            } else delete orders[item.n].lunch;
            
            if(document.getElementById('sec-dinner').classList.contains('active')) {
                orders[item.n].dinner = { 
                    active:true, 
                    count:getQty('dinner'), 
                    mode:document.getElementById('sec-dinner').dataset.mode||'cook', 
                    note:getVal('note-dinner') 
                };
            } else delete orders[item.n].dinner;
        }
        closeModal('orderModal'); renderAll();
    }

    function getQty(t) { return parseInt(document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner')).innerText); }
    function getVal(id) { return document.getElementById(id).value; }
    function adjQty(t, d) {
        const el = document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner'));
        let v = parseInt(el.innerText) + d; if(v<1) v=1; el.innerText = v;
    }
    function setDinnerMode(m, ui=true) {
        document.getElementById('sec-dinner').dataset.mode = m;
        document.getElementById('opt-cook').className = m==='cook'?'toggle-opt selected':'toggle-opt';
        document.getElementById('opt-prep').className = m==='prep'?'toggle-opt selected':'toggle-opt';
        if(ui) document.getElementById('note-dinner').value = m==='prep'?(orderCtx.item.prep||""):"";
    }
    
    function renderSettings() {
        renderChips('chips-lunchPpl', data.options.lunchPpl, 'lunchPpl');
        renderChips('chips-dinnerRice', data.options.dinnerRice, 'dinnerRice');
    }
    function renderChips(id, list, key) {
        const el = document.getElementById(id); el.innerHTML="";
        list.forEach((txt, i)=>{
            const isSel = (key==='lunchPpl' && tmpL===txt) || (key==='dinnerRice' && tmpD===txt);
            const d = document.createElement('div');
            d.className = `chip ${isSel ? (key==='lunchPpl'?'lunch-active':'dinner-active') : ''}`;
            d.innerHTML = `${txt}<div class="chip-del" onclick="event.stopPropagation();delOpt('${key}',${i})">Ã—</div>`;
            d.onclick = () => {
                if(!document.body.classList.contains('edit-mode')) {
                    if(key==='lunchPpl') tmpL = (tmpL===txt?"":txt);
                    else tmpD = (tmpD===txt?"":txt);
                    renderSettings();
                }
            };
            el.appendChild(d);
        });
        const add = document.createElement('div'); add.className="chip"; add.style.border="1px dashed #ccc"; add.innerHTML="+";
        add.onclick=()=>{ if(document.body.classList.contains('edit-mode')) {const v=prompt("æ·»åŠ "); if(v){data.options[key].push(v); renderSettings();}} };
        el.appendChild(add);
    }
    function delOpt(k,i) { data.options[k].splice(i,1); renderSettings(); }
    function editLabel(k) { const v=prompt("æ–°æ ‡é¢˜", data.labels[k]); if(v){data.labels[k]=v; renderSettings();} }
    
    function generate() {
        // å…ˆé‡ç½®æŒ‰é’®çŠ¶æ€
        const btn = document.getElementById('btn-copy');
        btn.innerText = "ğŸ“„ å¤åˆ¶å†…å®¹";
        btn.style.backgroundColor = "var(--primary)";

        let msg = "é˜¿å§¨ï¼Œæ˜å¤©é¥­èœå®‰æ’ï¼š\n";
        let bf=[], lu=[], di=[];
        
        for(let k in orders) {
            if(orders[k].bf?.active) bf.push(`${k}${orders[k].bf.count>1?' x'+orders[k].bf.count:''} ${orders[k].bf.note?('('+orders[k].bf.note+')'):''}`);
            if(orders[k].lunch?.active) lu.push(`${k}${orders[k].lunch.count>1?' x'+orders[k].lunch.count:''} ${orders[k].lunch.note?('('+orders[k].lunch.note+')'):''}`);
            if(orders[k].dinner?.active) {
                const d=orders[k].dinner;
                di.push(`${d.mode==='prep'?'ğŸ”ª ':'ğŸ³ '}${k}${d.count>1?' x'+d.count:''} ${d.note?('('+d.note+')'):''}`);
            }
        }
        
        if(bf.length) msg+=`\nâ˜€ï¸ã€æ—©é¤ã€‘\n${bf.join('ï¼Œ')}`;
        if(lu.length||tmpL) msg+=`\n\nğŸ±ã€ä¸­é¤ã€‘${tmpL?(' '+tmpL):''}\n${lu.join('ï¼Œ')}${document.getElementById('input-lunch-extra').value?('\nè¡¥å……: '+document.getElementById('input-lunch-extra').value):''}`;
        if(di.length||tmpD) msg+=`\n\nğŸŒ™ã€æ™šé¤ã€‘${tmpD?(' ç±³é¥­:'+tmpD):''}\n${di.join('\n')}${document.getElementById('input-dinner-extra').value?('\nè¡¥å……: '+document.getElementById('input-dinner-extra').value):''}`;
        
        const gn = document.getElementById('global-note').value;
        if(gn) msg+=`\n\nğŸ“ã€å¤‡æ³¨ã€‘\n${gn}`;
        msg+="\n\nè¾›è‹¦é˜¿å§¨äº†ï¼";
        
        document.getElementById('final-text').value=msg; document.getElementById('resultModal').classList.add('show');
    }
    
    // æ”¹è¿›çš„å¤åˆ¶é€»è¾‘
    function copyText(){ 
        document.getElementById('final-text').select(); 
        document.execCommand('copy'); 
        
        // è§†è§‰åé¦ˆï¼Œè€Œä¸æ˜¯å¼¹çª—
        const btn = document.getElementById('btn-copy');
        btn.innerText = "âœ… å·²å¤åˆ¶";
        btn.style.backgroundColor = "#34C759";
    }
    
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function switchTab(t){ 
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
        document.getElementById('tab-'+t).classList.add('active');
    }

    init();
</script>
</body>
</html>
