<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿å§¨ç®¡å®¶ V16 (å®Œç¾äº¤äº’ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; --lunch-color: #FF9500; --dinner-color: #5856D6;
            --bf-color: #34C759; --bg: #F2F2F7; --card-bg: #FFFFFF;
            --text-main: #1C1C1E; --text-sub: #8E8E93; --radius: 12px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            background-color: var(--bg); color: var(--text-main); margin: 0;
            padding-bottom: 120px; 
            -webkit-tap-highlight-color: transparent; 
            /* å…¨å±€ç¦æ­¢é€‰ä¸­æ–‡å­—ï¼Œé˜²æ­¢æ‹–æ‹½å†²çª */
            user-select: none; -webkit-user-select: none;
        }

        /* --- é¡¶éƒ¨å¯¼èˆªæ  (ä¿å­˜æŒ‰é’®å®Œç¾èåˆåœ¨è¿™é‡Œ) --- */
        .header {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 12px 20px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header h1 { margin: 0; font-size: 18px; font-weight: 800; }
        
        /* è¿™æ˜¯ä¸€ä¸ªå¤šæ€æŒ‰é’®ï¼šç¼–è¾‘æ—¶å˜è‰² */
        .action-btn {
            font-size: 14px; color: var(--primary); background: rgba(0,122,255,0.1);
            padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease;
        }
        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„æŒ‰é’®æ ·å¼ */
        .action-btn.saving-mode {
            background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }

        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex; background: var(--card-bg); padding: 4px; margin: 10px 15px;
            border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .tab {
            flex: 1; text-align: center; padding: 8px 0; font-size: 14px; font-weight: 600;
            color: var(--text-sub); border-radius: 10px; transition: 0.2s;
        }
        .tab.active { background: #E4EBF5; color: var(--primary); }

        /* å†…å®¹åŒº */
        .section { display: none; padding: 0 15px; }
        .section.active { display: block; }

        /* åˆ†ç±»å— */
        .cat-wrapper { margin-bottom: 20px; }
        .cat-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 5px; 
        }
        .cat-title { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .cat-title::before { content:''; width:4px; height:16px; background:var(--primary); border-radius:2px; }
        
        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„å›¾æ ‡ */
        .icon-btn { display: none; font-size: 14px; padding: 5px 10px; color: var(--text-sub); }
        body.edit-mode .icon-btn { display: inline-block; }
        body.edit-mode .cat-header { background: rgba(0,0,0,0.03); border-radius: 8px; margin-bottom: 8px; } /* ç¼–è¾‘æ¨¡å¼ä¸‹åˆ†ç±»å¤´åŠ æ·±èƒŒæ™¯æ–¹ä¾¿æ‹–æ‹½ */

        /* èœå“ç½‘æ ¼ */
        .grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); 
            gap: 12px; min-height: 20px; 
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
            position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; border: 2px solid transparent;
            /* å…³é”®ï¼šé˜²æ­¢iOSé•¿æŒ‰å¼¹å‡ºèœå•ï¼Œç¡®ä¿èƒ½æ‹–æ‹½ */
            -webkit-touch-callout: none; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:active { transform: scale(0.97); }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .card.sel-bf { border-color: var(--bf-color); background: #F0FFF4; }
        .card.sel-lunch { border-color: var(--lunch-color); background: #FFF8F0; }
        .card.sel-dinner { border-color: var(--dinner-color); background: #F4F4FF; }
        .card.sel-both { border-color: var(--primary); background: #F0F8FF; }

        /* æ‹–æ‹½æ—¶çš„æ ·å¼ (SortableJS è‡ªåŠ¨æ·»åŠ ) */
        .sortable-ghost { opacity: 0.4; background: #eee; }
        .sortable-drag { transform: scale(1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 999; opacity: 1; }

        .card-img { width: 100%; height: 85px; object-fit: cover; background: #eee; pointer-events: none; }
        .card-body { padding: 10px 6px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; pointer-events: none; }
        .card-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin: 1px;}
        .bg-bf { background: var(--bf-color); } .bg-lunch { background: var(--lunch-color); }
        .bg-dinner { background: var(--dinner-color); } .bg-prep { background: #8E8E93; }

        /* å¡ç‰‡ä¸Šçš„åˆ é™¤/ç¼–è¾‘é®ç½© - ä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤º */
        .card-mask {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.8); z-index: 10; display: none;
            align-items: center; justify-content: center; flex-direction: column; gap: 8px;
        }
        body.edit-mode .card-mask { display: flex; }
        .mini-btn { font-size: 12px; padding: 4px 10px; border-radius: 15px; border: 1px solid #ccc; background: white; }

        /* åº•éƒ¨ç”ŸæˆæŒ‰é’® */
        .footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            padding: 12px 20px; border-top: 1px solid #eee; z-index: 200;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        .btn-submit {
            width: 100%; background: var(--text-main); color: white; border: none;
            padding: 14px; border-radius: 25px; font-weight: 600; font-size: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        /* å¼¹çª—é€šç”¨ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-sheet {
            background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15); animation: slideUp 0.2s ease-out;
            padding-bottom: max(25px, env(safe-area-inset-bottom)); max-height: 85vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; background: #F9F9F9; font-size: 16px; margin-bottom: 10px; }
        .btn-full { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 600; font-size: 15px; cursor: pointer; margin-top: 5px;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #FF3B30; color: white; }
        
        /* å›¾ç‰‡ä¸Šä¼  */
        .upload-area {
            width: 100%; height: 100px; border: 2px dashed #ccc; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: #999; font-weight: 600; margin-bottom: 15px; background-size: contain; background-repeat: no-repeat; background-position: center;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel { background: var(--card-bg); padding: 15px; border-radius: var(--radius); margin-bottom: 15px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;}
        .chip { padding: 6px 12px; background: #F2F2F7; border-radius: 18px; font-size: 13px; position: relative; }
        .chip.active { color: white; }
        .chip.lunch-active { background: var(--lunch-color); }
        .chip.dinner-active { background: var(--dinner-color); }
        .chip-del { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #FF3B30; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold;}
        body.edit-mode .chip-del { display: flex; }

        /* ç‚¹é¤è¯¦æƒ…ç»„ä»¶ */
        .meal-section { background: #F9F9F9; border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 2px solid transparent; }
        .meal-section.active { border-color: var(--primary); background: #F0F8FF; }
        .meal-section.active-bf { border-color: var(--bf-color); background: #F0FFF4; }
        .meal-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .detail-box { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #rgba(0,0,0,0.05); }
        .meal-section.active .detail-box, .meal-section.active-bf .detail-box { display: block; }
        .stepper { display: flex; gap: 10px; align-items: center; }
        .step-btn { width: 28px; height: 28px; background: #eee; border: none; border-radius: 50%; font-weight: bold; font-size: 16px;}
        .toggle-row { display: flex; background: #EEE; padding: 3px; border-radius: 8px; margin-bottom: 10px; }
        .toggle-opt { flex: 1; text-align: center; padding: 6px; font-size: 13px; border-radius: 6px; color: #888; }
        .toggle-opt.selected { background: white; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ± é˜¿å§¨ç®¡å®¶ V16</h1>
    <div class="action-btn" id="mainActionBtn" onclick="toggleEditMode()">âœ ç¼–è¾‘ / æ’åº</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('bf')">æ—©é¤</div>
    <div class="tab" onclick="switchTab('main')">æ­£é¤ (åˆ/æ™š)</div>
</div>

<div id="tab-bf" class="section active">
    <div id="container-bf"></div>
    <button class="btn-full btn-primary" id="add-cat-bf" style="display:none; margin-top:20px;" onclick="addCategory('bf')">+ æ–°å¢æ—©é¤åˆ†ç±»</button>
</div>

<div id="tab-main" class="section">
    <div class="settings-panel">
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:700; font-size:14px;">â˜€ï¸ ä¸­é¤äººæ•°</span>
            <span class="icon-btn" onclick="editLabel('lunchPpl')">é‡å‘½å</span>
        </div>
        <div class="chip-container" id="chips-lunchPpl"></div>
        <input type="text" id="input-lunch-extra" placeholder="å¤‡æ³¨ (åœŸè±†/çº¢è–¯ç­‰)" style="margin-top:10px; border:none; border-bottom:1px solid #eee; background:transparent;">
        
        <div style="height:15px;"></div>
        
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:700; font-size:14px;">ğŸŒ™ æ™šé¤ç±³é¥­</span>
            <span class="icon-btn" onclick="editLabel('dinnerRice')">é‡å‘½å</span>
        </div>
        <div class="chip-container" id="chips-dinnerRice"></div>
        <input type="text" id="input-dinner-extra" placeholder="å¤‡æ³¨ (åœŸè±†/çº¢è–¯ç­‰)" style="margin-top:10px; border:none; border-bottom:1px solid #eee; background:transparent;">
    </div>

    <div id="container-main"></div>
    <button class="btn-full btn-primary" id="add-cat-main" style="display:none; margin-top:20px;" onclick="addCategory('main')">+ æ–°å¢æ­£é¤åˆ†ç±»</button>
    
    <div class="cat-wrapper" style="margin-top:20px;">
        <div class="cat-title">ğŸ“ é¢å¤–å¤‡æ³¨</div>
        <textarea id="global-note" rows="3" placeholder="ä¾‹å¦‚ï¼šæ”¶å¿«é€’ã€æ‰“æ‰«å«ç”Ÿ..." style="margin-top:10px;"></textarea>
    </div>
</div>

<div class="footer">
    <button class="btn-submit" onclick="generate()">ç”Ÿæˆå¾®ä¿¡æ¶ˆæ¯</button>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span class="sheet-title" id="om-title"></span>
            <span style="font-size:24px;color:#ccc" onclick="closeModal('orderModal')">Ã—</span>
        </div>

        <div id="panel-bf">
            <div class="meal-section" id="sec-bf" onclick="toggleMeal('bf')">
                <div class="meal-header"><span>â˜€ï¸ æ—©é¤åƒ</span><span id="chk-bf" style="color:var(--bf-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>æ•°é‡</span><div class="stepper"><button class="step-btn" onclick="adjQty('bf',-1)">-</button><span id="qty-bf">1</span><button class="step-btn" onclick="adjQty('bf',1)">+</button></div>
                    </div>
                    <input type="text" id="note-bf" placeholder="å¤‡æ³¨ (å¦‚: å°‘ç³–)">
                </div>
            </div>
        </div>

        <div id="panel-main">
            <div class="meal-section" id="sec-lunch" onclick="toggleMeal('lunch')">
                <div class="meal-header"><span>â˜€ï¸ åˆé¤åƒ</span><span id="chk-lunch" style="color:var(--lunch-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>ä»½æ•°</span><div class="stepper"><button class="step-btn" onclick="adjQty('lunch',-1)">-</button><span id="qty-lunch">1</span><button class="step-btn" onclick="adjQty('lunch',1)">+</button></div>
                    </div>
                    <input type="text" id="note-lunch" placeholder="å¤‡æ³¨ (å¦‚: å°‘è¾£)">
                </div>
            </div>
            <div class="meal-section" id="sec-dinner" onclick="toggleMeal('dinner')">
                <div class="meal-header"><span>ğŸŒ™ æ™šé¤åƒ</span><span id="chk-dinner" style="color:var(--dinner-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>ä»½æ•°</span><div class="stepper"><button class="step-btn" onclick="adjQty('dinner',-1)">-</button><span id="qty-dinner">1</span><button class="step-btn" onclick="adjQty('dinner',1)">+</button></div>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-opt selected" id="opt-cook" onclick="setDinnerMode('cook')">ğŸ‘©â€ğŸ³ é˜¿å§¨åšç†Ÿ</div>
                        <div class="toggle-opt" id="opt-prep" onclick="setDinnerMode('prep')">ğŸ”ª å¸®å¿™åˆ‡é…</div>
                    </div>
                    <input type="text" id="note-dinner" placeholder="å¤‡æ³¨ / åˆ‡é…è¯¦æƒ…">
                </div>
            </div>
        </div>
        <button class="btn-full btn-primary" onclick="confirmOrder()">ç¡®å®š</button>
    </div>
</div>

<div id="dishModal" class="modal-overlay">
    <div class="modal-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span class="sheet-title" id="dm-title"></span>
            <span style="font-size:24px;color:#ccc" onclick="closeModal('dishModal')">Ã—</span>
        </div>
        <label>èœå“åç§°</label><input type="text" id="dm-name">
        <label>é»˜è®¤åˆ‡é…/å¤‡æ³¨</label><input type="text" id="dm-prep">
        <label>å›¾ç‰‡ (è‡ªåŠ¨å‹ç¼©)</label>
        <label class="upload-area" id="dm-preview" for="file-input"><span>ğŸ“· ç‚¹å‡»ä¸Šä¼ </span></label>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">
        <input type="hidden" id="dm-img-data">
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-full btn-danger" id="dm-btn-del" onclick="deleteDish()">åˆ é™¤</button>
            <button class="btn-full btn-primary" onclick="saveDishTemp()">ç¡®å®š</button>
        </div>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-title" style="margin-bottom:15px;">ç”Ÿæˆç»“æœ</div>
        <textarea id="final-text" style="height:200px;"></textarea>
        <button class="btn-full btn-primary" onclick="copyText()">å¤åˆ¶å†…å®¹</button>
    </div>
</div>

<script>
    // --- æ•°æ® ---
    const defaultData = {
        bf: { "ä¸»é£Ÿ": [{n:"ç»¿è±†ç²¥"}, {n:"ç‰ç±³"}], "é¸¡è›‹": [{n:"æ°´ç…®è›‹"}], "é¥®å“": [{n:"ç‰›å¥¶"}] },
        main: { "è‚‰ç±»": [{n:"çº¢çƒ§è‚‰"}], "ç´ èœ": [{n:"ç‚’é’èœ"}] },
        options: { lunchPpl: ["2äºº", "3äºº"], dinnerRice: ["1äººä»½", "ä¸ç”¨"] },
        labels: { lunchPpl: "ä¸­é¤äººæ•°", dinnerRice: "æ™šé¤ç±³é¥­" }
    };
    let data = {}; let orders = {}; 
    let orderCtx=null; let editCtx=null;

    // --- åˆå§‹åŒ– ---
    function init() {
        const saved = localStorage.getItem('aygj_v16');
        if(saved) try{ data = JSON.parse(saved); }catch(e){ data=JSON.parse(JSON.stringify(defaultData)); }
        else data = JSON.parse(JSON.stringify(defaultData));
        renderAll();
    }
    
    // --- æ ¸å¿ƒé€»è¾‘ï¼šåˆ‡æ¢ç¼–è¾‘æ¨¡å¼ (é›†æˆä¿å­˜) ---
    function toggleEditMode() {
        const body = document.body;
        const btn = document.getElementById('mainActionBtn');
        
        if (body.classList.contains('edit-mode')) {
            // åŠ¨ä½œï¼šä¿å­˜å¹¶é€€å‡º
            saveDataReal();
            body.classList.remove('edit-mode');
            btn.innerText = "âœ ç¼–è¾‘ / æ’åº";
            btn.classList.remove('saving-mode');
            document.getElementById('add-cat-bf').style.display = 'none';
            document.getElementById('add-cat-main').style.display = 'none';
            
            // é‡æ–°æ¸²æŸ“ä»¥ç§»é™¤æ‹–æ‹½åŠŸèƒ½ (æ¢å¤ç‚¹å‡»ç‚¹é¤)
            renderAll(); 
        } else {
            // åŠ¨ä½œï¼šè¿›å…¥ç¼–è¾‘
            body.classList.add('edit-mode');
            btn.innerText = "ğŸ’¾ ä¿å­˜ä¿®æ”¹";
            btn.classList.add('saving-mode');
            document.getElementById('add-cat-bf').style.display = 'block';
            document.getElementById('add-cat-main').style.display = 'block';
            
            // é‡æ–°æ¸²æŸ“ä»¥æ¿€æ´»æ‹–æ‹½
            renderAll();
        }
    }

    function saveDataReal() {
        try {
            localStorage.setItem('aygj_v16', JSON.stringify(data));
            alert("âœ… æ‰€æœ‰ä¿®æ”¹å·²ä¿å­˜ï¼");
        } catch(e) { alert("ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡å¤ªå¤šäº†ã€‚"); }
    }

    // --- æ¸²æŸ“ ---
    function renderAll() {
        renderTab('bf', 'container-bf');
        renderTab('main', 'container-main');
        renderSettings();
    }

    function renderTab(tab, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const isEdit = document.body.classList.contains('edit-mode');
        const db = data[tab];

        // æ¸²æŸ“åˆ†ç±»
        for (let cat in db) {
            const wrapper = document.createElement('div');
            wrapper.className = "cat-wrapper";
            wrapper.dataset.cat = cat; // ä¾›å¤§ç±»æ’åºç”¨

            const header = document.createElement('div');
            header.className = "cat-header";
            header.innerHTML = `
                <div class="cat-title"><span>${cat}</span> <span class="icon-btn" onclick="renameCat('${tab}','${cat}')">âœ</span> <span class="icon-btn" style="color:#FF3B30" onclick="delCat('${tab}','${cat}')">ğŸ—‘</span></div>
                <div class="icon-btn" style="color:var(--primary);font-weight:bold;" onclick="openDishModal('${tab}','${cat}',-1)">+ åŠ èœ</div>
            `;
            
            const grid = document.createElement('div');
            grid.className = "grid";
            
            db[cat].forEach((item, idx) => {
                grid.appendChild(createCard(item, tab, cat, idx));
            });

            wrapper.appendChild(header);
            wrapper.appendChild(grid);
            container.appendChild(wrapper);

            // ç»‘å®šèœå“æ‹–æ‹½ (ä»…ç¼–è¾‘æ¨¡å¼)
            if (isEdit) {
                new Sortable(grid, {
                    group: 'dishes-'+tab, // å…è®¸è·¨åˆ†ç±»æ‹–æ‹½(å¦‚æœéœ€è¦å¯ä»¥å¼€å¯ï¼Œè¿™é‡Œæš‚ä¸å¼€å¯)
                    animation: 150,
                    delay: 200, // é•¿æŒ‰200ms
                    delayOnTouchOnly: true,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: (evt) => {
                        // æ‹–æ‹½ç»“æŸï¼Œæ›´æ–°æ•°æ®
                        const itemData = data[tab][cat].splice(evt.oldIndex, 1)[0];
                        data[tab][cat].splice(evt.newIndex, 0, itemData);
                    }
                });
            }
        }

        // ç»‘å®šå¤§ç±»æ‹–æ‹½
        if (isEdit) {
            new Sortable(container, {
                animation: 150,
                handle: '.cat-header', // åªèƒ½æŒ‰ä½æ ‡é¢˜æ‹–åŠ¨
                onEnd: (evt) => {
                    // ç®€å•çš„é‡æ–°æ„å»ºå¯¹è±¡æ¥æ’åº
                    const newDb = {};
                    const wrappers = container.querySelectorAll('.cat-wrapper');
                    wrappers.forEach(w => {
                        const cName = w.dataset.cat;
                        newDb[cName] = data[tab][cName];
                    });
                    data[tab] = newDb;
                }
            });
        }
    }

    function createCard(item, tab, cat, idx) {
        const div = document.createElement('div');
        const order = orders[item.n];
        let cls = "card"; let badges = "";
        if(order) {
            if(order.bf?.active) { cls+=" sel-bf"; badges+=`<span class="badge bg-bf">æ—©</span>`; }
            if(order.lunch?.active) { cls+=" sel-lunch"; badges+=`<span class="badge bg-lunch">åˆ</span>`; }
            if(order.dinner?.active) { 
                if(cls.includes("sel-lunch")) cls="card sel-both"; else cls+=" sel-dinner";
                badges+=`<span class="badge ${order.dinner.mode==='prep'?'bg-prep':'bg-dinner'}">${order.dinner.mode==='prep'?'åˆ‡':'æ™š'}</span>`;
            }
        }
        
        const imgUrl = item.img || `https://via.placeholder.com/150?text=${item.n[0]}`;
        div.className = cls;
        div.innerHTML = `
            <img src="${imgUrl}" class="card-img">
            <div class="card-body"><div class="card-name">${item.n}</div><div>${badges}</div></div>
            <div class="card-mask">
                <div class="mini-btn" onclick="event.stopPropagation();openDishModal('${tab}','${cat}',${idx})">âœ ä¿®æ”¹</div>
            </div>
        `;
        // æ­£å¸¸æ¨¡å¼ç‚¹å‡»ç‚¹é¤ï¼Œç¼–è¾‘æ¨¡å¼æ— ç‚¹å‡»(ç”±Sortableæ¥ç®¡)
        div.onclick = () => { if(!document.body.classList.contains('edit-mode')) openOrderModal(item, tab); };
        return div;
    }

    // --- ä¸šåŠ¡é€»è¾‘: åˆ†ç±» ---
    function addCategory(tab) {
        const n = prompt("æ–°åˆ†ç±»åç§°");
        if(n && !data[tab][n]) { data[tab][n]=[]; renderAll(); }
    }
    function renameCat(tab, old) {
        const n = prompt("ä¿®æ”¹åç§°", old);
        if(n && n!==old && !data[tab][n]) {
            const items = data[tab][old];
            delete data[tab][old];
            data[tab][n] = items; // æ³¨æ„ï¼šJSå¯¹è±¡é¡ºåºå¯èƒ½å˜ï¼Œä½†åœ¨æˆ‘ä»¬ä¸‹ä¸€æ¬¡ä¿å­˜æ‹–æ‹½åä¼šä¿®å¤
            renderAll();
        }
    }
    function delCat(tab, cat) {
        if(confirm(`åˆ é™¤åˆ†ç±»ã€${cat}ã€‘åŠæ‰€æœ‰èœå“ï¼Ÿ`)) { delete data[tab][cat]; renderAll(); }
    }

    // --- ä¸šåŠ¡é€»è¾‘: èœå“ç¼–è¾‘ ---
    function openDishModal(tab, cat, idx) {
        editCtx = { tab, cat, idx, isNew: idx===-1 };
        const item = idx===-1 ? {n:"", prep:""} : data[tab][cat][idx];
        document.getElementById('dm-title').innerText = editCtx.isNew ? "æ·»åŠ èœå“" : "ä¿®æ”¹èœå“";
        document.getElementById('dm-name').value = item.n;
        document.getElementById('dm-prep').value = item.prep || "";
        document.getElementById('dm-preview').style.backgroundImage = item.img ? `url(${item.img})` : "none";
        document.getElementById('dm-img-data').value = item.img || "";
        document.getElementById('dm-btn-del').style.display = editCtx.isNew ? 'none' : 'block';
        document.getElementById('dishModal').classList.add('show');
    }
    function handleFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                // å‹ç¼©
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const scale = 300/img.width;
                    cvs.width=300; cvs.height=img.height*scale;
                    cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                    const zip = cvs.toDataURL('image/jpeg', 0.7);
                    document.getElementById('dm-preview').style.backgroundImage = `url(${zip})`;
                    document.getElementById('dm-img-data').value = zip;
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    function saveDishTemp() {
        const n = document.getElementById('dm-name').value; if(!n) return;
        const item = { n, img: document.getElementById('dm-img-data').value, prep: document.getElementById('dm-prep').value };
        if(editCtx.isNew) data[editCtx.tab][editCtx.cat].push(item);
        else data[editCtx.tab][editCtx.cat][editCtx.idx] = item;
        closeModal('dishModal'); renderAll();
    }
    function deleteDish() {
        if(confirm("åˆ é™¤ï¼Ÿ")) {
            data[editCtx.tab][editCtx.cat].splice(editCtx.idx, 1);
            delete orders[editCtx.n]; // å°è¯•åˆ å…³è”è®¢å•
            closeModal('dishModal'); renderAll();
        }
    }

    // --- ä¸šåŠ¡é€»è¾‘: ç‚¹é¤ & è®¾ç½® (ç»´æŒåŸæœ‰é€»è¾‘ç®€åŒ–ç‰ˆ) ---
    function openOrderModal(item, tab) {
        orderCtx = { item, tab };
        const order = orders[item.n] || {};
        document.getElementById('om-title').innerText = item.n;
        document.getElementById('panel-bf').style.display = tab==='bf'?'block':'none';
        document.getElementById('panel-main').style.display = tab==='main'?'block':'none';
        
        if(tab==='bf') updateUI('bf', order.bf);
        else { updateUI('lunch', order.lunch); updateUI('dinner', order.dinner); 
               setDinnerMode(order.dinner?.mode||'cook', false); 
               document.getElementById('note-dinner').value = order.dinner?.note || (order.dinner?.mode==='prep'?item.prep:'') || ""; }
        
        document.getElementById('orderModal').classList.add('show');
    }
    function updateUI(t, d) {
        const sec = document.getElementById(t==='bf'?'sec-bf':(t==='lunch'?'sec-lunch':'sec-dinner'));
        const chk = document.getElementById(t==='bf'?'chk-bf':(t==='lunch'?'chk-lunch':'chk-dinner'));
        const qty = document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner'));
        const note = document.getElementById(t==='bf'?'note-bf':(t==='lunch'?'note-lunch':'note-dinner'));
        
        if(d && d.active) {
            sec.classList.add(t==='bf'?'active-bf':'active'); chk.innerText="âœ“"; qty.innerText=d.count; 
            if(t!=='dinner') note.value=d.note||"";
        } else {
            sec.classList.remove(t==='bf'?'active-bf':'active'); chk.innerText=""; qty.innerText=1; 
            if(t!=='dinner') note.value="";
        }
    }
    function confirmOrder() {
        const item = orderCtx.item;
        if(!orders[item.n]) orders[item.n] = {};
        
        if(orderCtx.tab==='bf') {
            if(document.getElementById('sec-bf').classList.contains('active-bf'))
                orders[item.n].bf={active:true, count:getQty('bf'), note:getVal('note-bf')};
            else delete orders[item.n].bf;
        } else {
            if(document.getElementById('sec-lunch').classList.contains('active'))
                orders[item.n].lunch={active:true, count:getQty('lunch'), note:getVal('note-lunch')};
            else delete orders[item.n].lunch;
            
            if(document.getElementById('sec-dinner').classList.contains('active')) {
                const mode = document.getElementById('sec-dinner').dataset.mode||'cook';
                orders[item.n].dinner={active:true, count:getQty('dinner'), mode, note:getVal('note-dinner')};
            } else delete orders[item.n].dinner;
        }
        closeModal('orderModal'); renderAll();
    }
    
    // --- è¾…åŠ©å‡½æ•° ---
    function getQty(t) { return parseInt(document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner')).innerText); }
    function getVal(id) { return document.getElementById(id).value; }
    function toggleMeal(t) { 
        const sec = document.getElementById(t==='bf'?'sec-bf':(t==='lunch'?'sec-lunch':'sec-dinner'));
        const cls = t==='bf'?'active-bf':'active';
        sec.classList.toggle(cls);
        // update Check icon
        const chk = document.getElementById(t==='bf'?'chk-bf':(t==='lunch'?'chk-lunch':'chk-dinner'));
        chk.innerText = sec.classList.contains(cls) ? "âœ“" : "";
    }
    function setDinnerMode(m, ui=true) {
        document.getElementById('sec-dinner').dataset.mode = m;
        document.getElementById('opt-cook').className = m==='cook'?'toggle-opt selected':'toggle-opt';
        document.getElementById('opt-prep').className = m==='prep'?'toggle-opt selected':'toggle-opt';
        if(ui) document.getElementById('note-dinner').value = m==='prep'?(orderCtx.item.prep||""):"";
    }
    function adjQty(t, d) {
        const el = document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner'));
        let v=parseInt(el.innerText)+d; if(v<1)v=1; el.innerText=v;
    }
    function renderSettings() {
        renderChips('chips-lunchPpl', data.options.lunchPpl, 'lunchPpl');
        renderChips('chips-dinnerRice', data.options.dinnerRice, 'dinnerRice');
    }
    function renderChips(id, list, key) {
        const el=document.getElementById(id); el.innerHTML="";
        list.forEach((txt, i)=>{
            const isSel = (key==='lunchPpl'&&window.tmpL===txt)||(key==='dinnerRice'&&window.tmpD===txt);
            const d = document.createElement('div'); 
            d.className=`chip ${isSel?(key==='lunchPpl'?'lunch-active':'dinner-active'):''}`;
            d.innerHTML = `${txt}<div class="chip-del" onclick="event.stopPropagation();delOpt('${key}',${i})">Ã—</div>`;
            d.onclick=()=>{ if(!document.body.classList.contains('edit-mode')){ if(key==='lunchPpl')window.tmpL=txt; else window.tmpD=txt; renderSettings(); }};
            el.appendChild(d);
        });
        const add = document.createElement('div'); add.className="chip"; add.style.border="1px dashed #ccc"; add.innerHTML="+";
        add.onclick=()=>{ if(document.body.classList.contains('edit-mode')) {const v=prompt("æ·»åŠ "); if(v){data.options[key].push(v); renderSettings();}} };
        el.appendChild(add);
    }
    function delOpt(k,i) { data.options[k].splice(i,1); renderSettings(); }
    function editLabel(k) { const v=prompt("æ–°æ ‡é¢˜", data.labels[k]); if(v){data.labels[k]=v; renderSettings();} }
    function generate() {
        let msg = "é˜¿å§¨ï¼Œæ˜å¤©é¥­èœå®‰æ’ï¼š\n";
        // ç®€å•ç”Ÿæˆé€»è¾‘ (çœç•¥éƒ¨åˆ†ä»£ç ä»¥ä¿æŒé•¿åº¦ï¼Œé€»è¾‘åŒV15)
        let bf=[], lu=[], di=[];
        for(let k in orders) {
            if(orders[k].bf?.active) bf.push(`${k}${orders[k].bf.count>1?'x'+orders[k].bf.count:''}`);
            if(orders[k].lunch?.active) lu.push(`${k}${orders[k].lunch.count>1?'x'+orders[k].lunch.count:''}`);
            if(orders[k].dinner?.active) {
                const d=orders[k].dinner;
                di.push(`${d.mode==='prep'?'ğŸ”ª':'ğŸ³'}${k}${d.count>1?'x'+d.count:''} ${d.note||''}`);
            }
        }
        if(bf.length) msg+=`\nâ˜€ï¸æ—©é¤: ${bf.join(', ')}`;
        if(lu.length||window.tmpL) msg+=`\nğŸ±ä¸­é¤: ${window.tmpL||''} ${lu.join(', ')} ${document.getElementById('input-lunch-extra').value}`;
        if(di.length||window.tmpD) msg+=`\nğŸŒ™æ™šé¤: ${window.tmpD||''} ${di.join('\n')}\n${document.getElementById('input-dinner-extra').value}`;
        msg+=`\nå¤‡æ³¨: ${document.getElementById('global-note').value}`;
        document.getElementById('final-text').value=msg; document.getElementById('resultModal').classList.add('show');
    }
    function copyText(){ document.getElementById('final-text').select(); document.execCommand('copy'); alert("å·²å¤åˆ¶"); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function switchTab(t){ 
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
        document.getElementById('tab-'+t).classList.add('active');
    }
    init();
</script>
</body>
</html>
