<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§å¥‡å¥‡çš„ç¾å‘³æŒ‡ä»¤</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* --- V21 é…è‰² (ä¿æŒæ¸©é¦¨é£æ ¼) --- */
        :root {
            --primary: #FF7E67; /* çŠç‘šç²‰ */
            --bg: #FFF9F2;      /* å¥¶æ²¹é»„ */
            --card-bg: #FFFFFF;
            --text-main: #5D5550; 
            --text-sub: #9E948D;
            
            --lunch-color: #FFB03B; 
            --dinner-color: #8B80F9; 
            --bf-color: #6BCB77;     
            
            --radius: 20px;
            --shadow: 0 4px 20px rgba(255, 126, 103, 0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            background-color: var(--bg); 
            color: var(--text-main); 
            margin: 0;
            padding-bottom: 120px; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; -webkit-user-select: none;
        }

        /* --- é¡¶éƒ¨ --- */
        .header {
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(15px);
            padding: 15px 20px; 
            position: sticky; top: 0; z-index: 100;
            display: flex; flex-direction: column; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.02);
            box-shadow: 0 2px 15px rgba(0,0,0,0.03);
        }
        .header h1 { 
            margin: 0; font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: 1px;
        }
        .edit-trigger {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            font-size: 13px; background: #FFF0EB; color: var(--primary);
            padding: 6px 12px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .edit-trigger.saving-mode {
            background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 126, 103, 0.3);
        }

        /* --- æ ‡ç­¾é¡µ --- */
        .tabs { display: flex; background: rgba(255,255,255,0.6); padding: 6px; margin: 15px 20px; border-radius: 25px; }
        .tab { flex: 1; text-align: center; padding: 10px 0; font-size: 15px; font-weight: 700; color: var(--text-sub); border-radius: 20px; transition: 0.3s;}
        .tab.active { background: #FFFFFF; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05);}

        .section { display: none; padding: 0 20px; }
        .section.active { display: block; }

        /* --- å¡ç‰‡ä¸ç½‘æ ¼ --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 15px; min-height: 10px; }
        .cat-wrapper { margin-bottom: 20px; background: transparent; border-radius: var(--radius); transition: 0.2s; }
        body.edit-mode .cat-wrapper { background: rgba(255,255,255,0.6); padding: 10px; border: 2px dashed #FFD1C7; }

        .cat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; margin-bottom: 5px;}
        .cat-title { font-size: 18px; font-weight: 800; color: #6D635E; display: flex; align-items: center; gap: 8px; }
        .cat-title::before { content:''; width:6px; height:6px; background:var(--primary); border-radius:50%; }
        
        .tools { display: none; align-items: center; gap: 12px; }
        body.edit-mode .tools { display: flex; }
        .icon-btn { font-size: 14px; color: var(--text-sub); padding: 4px; }
        .drag-handle { font-size: 20px; color: #D1C7C0; cursor: grab; padding: 0 10px; touch-action: none; }

        .card {
            background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
            position: relative; box-shadow: var(--shadow);
            display: flex; flex-direction: column; 
            -webkit-touch-callout: none; transition: all 0.2s; border: 2px solid transparent;
        }
        .card:active { transform: scale(0.96); }
        .card.sel-bf { border-color: var(--bf-color); background: #F2FDF5; }
        .card.sel-lunch { border-color: var(--lunch-color); background: #FFF9F0; }
        .card.sel-dinner { border-color: var(--dinner-color); background: #F7F6FF; }
        .card.sel-both { border-color: var(--primary); background: #FFF0EB; }

        .card-img { width: 100%; height: 90px; object-fit: cover; background: #FFF5E8; pointer-events: none; }
        .card-body { padding: 12px 8px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; pointer-events: none; }
        .card-name { font-size: 14px; font-weight: 700; margin-bottom: 6px; color: #5D5550; }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 10px; color: white; display: inline-block; margin: 2px; font-weight: 600;}
        .bg-bf { background: var(--bf-color); } .bg-lunch { background: var(--lunch-color); }
        .bg-dinner { background: var(--dinner-color); } .bg-prep { background: #B8B2A9; }

        /* --- ä¿®å¤ï¼šç¼–è¾‘é®ç½©åªé®å›¾ç‰‡ï¼Œä¸é®æ–‡å­— --- */
        .card-mask {
            position: absolute; top:0; left:0; width:100%; height:90px; /* åªè¦†ç›–å›¾ç‰‡åŒºåŸŸ */
            background: rgba(255,255,255,0.6); z-index: 10; display: none;
            align-items: center; justify-content: center;
            backdrop-filter: blur(1px);
        }
        body.edit-mode .card-mask { display: flex; }
        .mini-btn { 
            font-size: 13px; padding: 6px 15px; border-radius: 20px; border: none; 
            background: white; color: var(--primary); border: 1px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-weight: bold; 
        }

        /* --- è®¾ç½®é¢æ¿ --- */
        .settings-panel { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .chip-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;}
        .chip { 
            padding: 8px 15px; background: #F7F4F2; border-radius: 20px; font-size: 13px; position: relative; 
            color: #6D635E; font-weight: 600;
        }
        .chip.bf-active { background: var(--bf-color); color: white; box-shadow: 0 3px 10px rgba(107, 203, 119, 0.3); }
        .chip.lunch-active { background: var(--lunch-color); color: white; box-shadow: 0 3px 10px rgba(255, 176, 59, 0.3); }
        .chip.dinner-active { background: var(--dinner-color); color: white; box-shadow: 0 3px 10px rgba(139, 128, 249, 0.3); }
        .chip-del { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #FF6B6B; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white;}
        body.edit-mode .chip-del { display: flex; }

        /* --- åº•éƒ¨ä¸å¼¹çª— --- */
        .footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            padding: 15px 25px; z-index: 200; padding-bottom: max(15px, env(safe-area-inset-bottom));
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
        }
        .btn-submit {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 16px; border-radius: 30px; font-weight: 700; font-size: 17px;
            box-shadow: 0 8px 20px rgba(255, 126, 103, 0.3); letter-spacing: 1px;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(93, 85, 80, 0.4); z-index: 300; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-sheet {
            background: #FFFFFF; width: 100%; max-width: 500px; border-radius: 30px 30px 0 0; padding: 25px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1); animation: slideUp 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding-bottom: max(30px, env(safe-area-inset-bottom)); max-height: 85vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        input, textarea { 
            width: 100%; padding: 14px; border: 2px solid #F2EEEA; border-radius: 16px; 
            box-sizing: border-box; background: #FCFAF8; font-size: 16px; margin-bottom: 12px; 
            color: var(--text-main);
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; background: white; }
        
        .btn-full { width: 100%; padding: 14px; border-radius: 18px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 8px;}
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(255, 126, 103, 0.2); }
        .btn-danger { background: #FFB0B0; color: white; }
        .btn-secondary { background: #F0EBE8; color: #6D635E; }

        .meal-section { 
            background: white; border-radius: 16px; padding: 18px; margin-bottom: 12px; 
            border: 2px solid #F5F0ED; transition: 0.2s; 
        }
        .meal-section.active { border-color: var(--primary); background: #FFF5F2; }
        .meal-section.active-bf { border-color: var(--bf-color); background: #F2FDF5; }
        .meal-header { display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 16px; }
        .detail-box { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed rgba(0,0,0,0.08); }
        .meal-section.active .detail-box, .meal-section.active-bf .detail-box { display: block; }

        .stepper { display: flex; gap: 15px; align-items: center; }
        .step-btn { 
            width: 32px; height: 32px; background: white; border: 2px solid #EFEBE9; border-radius: 50%; color: var(--primary);
            font-weight: 900; font-size: 18px; display:flex; align-items:center; justify-content:center;
        }
        
        .toggle-row { display: flex; background: #F0EBE8; padding: 4px; border-radius: 12px; margin-bottom: 12px; }
        .toggle-opt { flex: 1; text-align: center; padding: 10px; font-size: 14px; border-radius: 10px; color: #999; font-weight: 600;}
        .toggle-opt.selected { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .action-group { display: flex; gap: 15px; margin-top: 10px; }
        .action-group .btn-full { margin-top: 0; }
        
        /* ä¿®å¤ï¼šå–æ¶ˆé€‰æ‹©æŒ‰é’® */
        .btn-cancel-item {
            font-size: 13px; color: #FF6B6B; background: #FFF0F0; border: 1px solid #FFDEDE;
            padding: 6px 12px; border-radius: 15px; cursor: pointer; float: right; margin-top: 10px; font-weight: 600;
        }
        
        .upload-area {
            width: 100%; height: 110px; border: 2px dashed #E0D8D5; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            color: #B0A8A4; font-weight: 600; margin-bottom: 15px; background-color: #FAF8F6;
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ€ å¤§å¥‡å¥‡çš„ç¾å‘³æŒ‡ä»¤ ğŸ€</h1>
    <div class="edit-trigger" id="mainActionBtn" onclick="toggleEditMode()">âœ ç¼–è¾‘èœå•</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('bf')">â˜€ï¸ æ—©é¤æ—¶å…‰</div>
    <div class="tab" onclick="switchTab('main')">ğŸ± åˆæ™šæ­£é¤</div>
</div>

<div id="tab-bf" class="section active">
    <div class="settings-panel">
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:800; color:var(--bf-color);">â˜€ï¸ æ—©é¤å‡ äººåƒ?</span>
            <span class="tools icon-btn" onclick="editLabel('bfPpl')">âœ</span>
        </div>
        <div class="chip-container" id="chips-bfPpl"></div>
    </div>

    <div id="container-bf"></div>
    <button class="btn-full btn-primary" id="add-cat-bf" style="display:none; margin-top:20px; background:#81CFE0;" onclick="addCategory('bf')">+ æ–°å¢æ—©é¤ç§ç±»</button>
</div>

<div id="tab-main" class="section">
    <div class="settings-panel">
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:800; color:var(--lunch-color);">ğŸ± å‡ ä¸ªäººå¸¦é¥­?</span>
            <span class="tools icon-btn" onclick="editLabel('lunchPpl')">âœ</span>
        </div>
        <div class="chip-container" id="chips-lunchPpl"></div>
        <input type="text" id="input-lunch-extra" placeholder="å¤‡æ³¨ (å¦‚: æƒ³è¦åƒçº¢è–¯)" style="margin-top:12px;">
        
        <div style="height:25px;"></div>
        
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:800; color:var(--dinner-color);">ğŸŒ™ æ™šé¤å‡ ä¸ªäººåƒ?</span>
            <span class="tools icon-btn" onclick="editLabel('dinnerRice')">âœ</span>
        </div>
        <div class="chip-container" id="chips-dinnerRice"></div>
        <input type="text" id="input-dinner-extra" placeholder="å¤‡æ³¨ (å¦‚: åƒåœŸè±†/ä¸åƒç±³é¥­)" style="margin-top:12px;">
    </div>

    <div id="container-main"></div>
    <button class="btn-full btn-primary" id="add-cat-main" style="display:none; margin-top:20px; background:#81CFE0;" onclick="addCategory('main')">+ æ–°å¢æ­£é¤ç§ç±»</button>
    
    <div class="cat-wrapper" style="margin-top:25px;">
        <div class="cat-title" style="font-size:16px; margin-bottom:10px;">ğŸ’Œ ç»™é˜¿å§¨çš„æ‚„æ‚„è¯</div>
        <textarea id="global-note" rows="3" placeholder="ä¾‹å¦‚ï¼šè®°å¾—æ”¶å¿«é€’ã€æ‰“æ‰«å«ç”Ÿå‘€..."></textarea>
    </div>
</div>

<div class="footer">
    <button class="btn-submit" onclick="generate()">âœ¨ ç”Ÿæˆå¤§å¥‡å¥‡çš„æŒ‡ä»¤ âœ¨</button>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <span class="sheet-title" id="om-title"></span>
            <span style="font-size:28px;color:#E0D8D5; line-height:20px;" onclick="closeModal('orderModal')">Ã—</span>
        </div>

        <div id="panel-bf" style="display:none;">
            <div class="meal-section" id="sec-bf" onclick="toggleMeal('bf')">
                <div class="meal-header"><span>â˜€ï¸ æ—©é¤åƒè¿™ä¸ª</span><span id="chk-bf" style="color:var(--bf-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold; color:#888;">æ•°é‡</span>
                        <div class="stepper">
                            <button class="step-btn" onclick="adjQty('bf',-1)">-</button>
                            <span id="qty-bf" style="font-weight:900; font-size:18px; width:25px; text-align:center; color:var(--text-main);">1</span>
                            <button class="step-btn" onclick="adjQty('bf',1)">+</button>
                        </div>
                    </div>
                    <input type="text" id="note-bf" placeholder="å¤‡æ³¨ (å¦‚: å°‘ç³–)">
                    <button class="btn-cancel-item" onclick="event.stopPropagation(); toggleMeal('bf')">ğŸ—‘ï¸ ä¸åƒè¿™ä¸ªäº†</button>
                    <div style="clear:both"></div>
                </div>
            </div>
        </div>

        <div id="panel-main" style="display:none;">
            <div class="meal-section" id="sec-lunch" onclick="toggleMeal('lunch')">
                <div class="meal-header"><span>ğŸ± åˆé¤åƒè¿™ä¸ª</span><span id="chk-lunch" style="color:var(--lunch-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold; color:#888;">ä»½æ•°</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('lunch',-1)">-</button><span id="qty-lunch" style="font-weight:900; font-size:18px; width:25px; text-align:center; color:var(--text-main);">1</span><button class="step-btn" onclick="adjQty('lunch',1)">+</button></div>
                    </div>
                    <input type="text" id="note-lunch" placeholder="å¤‡æ³¨ (å¦‚: å°‘è¾£)">
                    <button class="btn-cancel-item" onclick="event.stopPropagation(); toggleMeal('lunch')">ğŸ—‘ï¸ ä¸åƒè¿™ä¸ªäº†</button>
                    <div style="clear:both"></div>
                </div>
            </div>
            <div class="meal-section" id="sec-dinner" onclick="toggleMeal('dinner')">
                <div class="meal-header"><span>ğŸŒ™ æ™šé¤åƒè¿™ä¸ª</span><span id="chk-dinner" style="color:var(--dinner-color)"></span></div>
                <div class="detail-box" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <span style="font-weight:bold; color:#888;">ä»½æ•°</span>
                        <div class="stepper"><button class="step-btn" onclick="adjQty('dinner',-1)">-</button><span id="qty-dinner" style="font-weight:900; font-size:18px; width:25px; text-align:center; color:var(--text-main);">1</span><button class="step-btn" onclick="adjQty('dinner',1)">+</button></div>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-opt selected" id="opt-cook" onclick="setDinnerMode('cook')">ğŸ‘©â€ğŸ³ é˜¿å§¨åšç†Ÿ</div>
                        <div class="toggle-opt" id="opt-prep" onclick="setDinnerMode('prep')">ğŸ”ª å¸®å¿™åˆ‡é…</div>
                    </div>
                    <input type="text" id="note-dinner" placeholder="æ€ä¹ˆåš? / æ€ä¹ˆåˆ‡?">
                    <button class="btn-cancel-item" onclick="event.stopPropagation(); toggleMeal('dinner')">ğŸ—‘ï¸ ä¸åƒè¿™ä¸ªäº†</button>
                    <div style="clear:both"></div>
                </div>
            </div>
        </div>
        <button class="btn-full btn-primary" onclick="confirmOrder()">å°±é€‰å®ƒå•¦ï¼â¤ï¸</button>
    </div>
</div>

<div id="dishModal" class="modal-overlay">
    <div class="modal-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <span class="sheet-title" id="dm-title"></span>
            <span style="font-size:28px;color:#E0D8D5; line-height:20px;" onclick="closeModal('dishModal')">Ã—</span>
        </div>
        <label style="font-weight:700; margin-bottom:5px; display:block;">èœå“åç§°</label><input type="text" id="dm-name">
        <label style="font-weight:700; margin-bottom:5px; display:block;">é»˜è®¤å¤‡æ³¨</label><input type="text" id="dm-prep">
        <label style="font-weight:700; margin-bottom:5px; display:block;">å›¾ç‰‡</label>
        <label class="upload-area" id="dm-preview" for="file-input"><span>ğŸ“· ç‚¹è¿™é‡Œä¼ å›¾</span></label>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFile(this)">
        <input type="hidden" id="dm-img-data">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-full btn-danger" id="dm-btn-del" onclick="deleteDish()">åˆ é™¤</button>
            <button class="btn-full btn-primary" onclick="saveDishTemp()">ä¿å­˜å¥½å•¦</button>
        </div>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="sheet-title" style="margin-bottom:15px; text-align:center;">ğŸ’Œ ç”Ÿæˆå¥½å•¦</div>
        <textarea id="final-text" style="height:200px; border-color:var(--primary); background:#FFF9F9;"></textarea>
        <div class="action-group">
            <button class="btn-full btn-secondary" onclick="closeModal('resultModal')">ğŸ”™è¿˜è¦æ”¹æ”¹</button>
            <button class="btn-full btn-primary" id="btn-copy" onclick="copyText()">ğŸ“„ å¤åˆ¶ç»™é˜¿å§¨</button>
        </div>
    </div>
</div>

<script>
    // --- æ•°æ®æ ¸å¿ƒ (å·²æ›´æ–°é»˜è®¤é€‰é¡¹) ---
    const defaultData = {
        bf: { "ğŸ¥ª æ¯æ—¥ä¸»é£Ÿ": [{n:"ç»¿è±†ç²¥"}, {n:"ç‰ç±³"}], "ğŸ¥š ä¼˜è´¨è›‹ç™½": [{n:"æ°´ç…®è›‹"}], "ğŸ¥› æ¯æ—¥é¥®å“": [{n:"ç‰›å¥¶"}] },
        main: { "ğŸ– å¤§å£åƒè‚‰": [{n:"çº¢çƒ§è‚‰"}], "ğŸ¥¬ æ¸…çˆ½ç´ èœ": [{n:"ç‚’é’èœ"}] },
        // ä¿®å¤ï¼šé€‰é¡¹å†…å®¹
        options: { 
            bfPpl: ["1äºº", "2äºº"],
            lunchPpl: ["1äººå¸¦é¥­", "2äººå¸¦é¥­", "ä¸å¸¦é¥­"], 
            dinnerRice: ["1äººç±³é¥­", "ä¸ç”¨ç±³é¥­", "1äººåœŸè±†", "2äººåœŸè±†"] 
        },
        // ä¿®å¤ï¼šæ ‡ç­¾åç§°
        labels: { bfPpl: "æ—©é¤å‡ äººåƒ", lunchPpl: "å‡ ä¸ªäººå¸¦é¥­", dinnerRice: "æ™šé¤å‡ ä¸ªäººåƒ" }
    };
    let data = {}; let orders = {}; 
    let orderCtx=null; let editCtx=null;
    // ä¸´æ—¶é€‰ä¸­çŠ¶æ€
    let tmpB = ""; let tmpL = ""; let tmpD = ""; 

    function init() {
        const saved = localStorage.getItem('aygj_v21'); 
        if(saved) {
            try { data = JSON.parse(saved); } catch(e) { data = JSON.parse(JSON.stringify(defaultData)); }
        } else {
            data = JSON.parse(JSON.stringify(defaultData));
        }
        // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        if(!data.bf) data.bf = {};
        if(!data.main) data.main = {};
        if(!data.options.bfPpl) data.options.bfPpl = ["1äºº", "2äºº"];
        if(!data.labels.bfPpl) data.labels.bfPpl = "æ—©é¤å‡ äººåƒ";
        
        renderAll();
    }

    function saveData() {
        try { localStorage.setItem('aygj_v21', JSON.stringify(data)); } catch(e) { console.error("Full"); }
    }

    function toggleEditMode() {
        const body = document.body;
        const btn = document.getElementById('mainActionBtn');
        if (body.classList.contains('edit-mode')) {
            saveData();
            alert("â¤ï¸ èœå•å·²ç»ä¿å­˜å¥½å•¦ï¼");
            body.classList.remove('edit-mode');
            btn.innerText = "âœ ç¼–è¾‘èœå•";
            btn.classList.remove('saving-mode');
            document.getElementById('add-cat-bf').style.display = 'none';
            document.getElementById('add-cat-main').style.display = 'none';
            renderAll(); 
        } else {
            body.classList.add('edit-mode');
            btn.innerText = "ğŸ’¾ ä¿å­˜";
            btn.classList.add('saving-mode');
            document.getElementById('add-cat-bf').style.display = 'block';
            document.getElementById('add-cat-main').style.display = 'block';
            renderAll(); 
        }
    }

    function renderAll() {
        renderTab('bf', 'container-bf');
        renderTab('main', 'container-main');
        renderSettings();
    }

    function renderTab(tab, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const isEdit = document.body.classList.contains('edit-mode');
        const db = data[tab];

        for (let cat in db) {
            const wrapper = document.createElement('div');
            wrapper.className = "cat-wrapper";
            wrapper.dataset.cat = cat; 

            const header = document.createElement('div');
            header.className = "cat-header";
            header.innerHTML = `
                <div class="cat-title">
                    <span>${cat}</span> 
                    <span class="tools">
                        <span class="icon-btn" onclick="renameCat('${tab}','${cat}')">âœ</span>
                        <span class="icon-btn" style="color:#FF6B6B" onclick="delCat('${tab}','${cat}')">ğŸ—‘</span>
                    </span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="tools icon-btn" style="color:var(--primary);font-weight:bold;" onclick="openDishModal('${tab}','${cat}',-1)">+ åŠ èœ</span>
                    ${isEdit ? '<span class="drag-handle">â‰¡</span>' : ''}
                </div>
            `;
            
            const grid = document.createElement('div');
            grid.className = "grid";
            
            db[cat].forEach((item, idx) => {
                grid.appendChild(createCard(item, tab, cat, idx));
            });

            wrapper.appendChild(header);
            wrapper.appendChild(grid);
            container.appendChild(wrapper);

            if (isEdit) {
                new Sortable(grid, {
                    animation: 200, delay: 200, delayOnTouchOnly: true,
                    ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                    onEnd: (evt) => {
                        const itemData = data[tab][cat].splice(evt.oldIndex, 1)[0];
                        data[tab][cat].splice(evt.newIndex, 0, itemData);
                    }
                });
            }
        }

        if (isEdit) {
            new Sortable(container, {
                animation: 200, handle: '.drag-handle', 
                onEnd: (evt) => {
                    const newDb = {};
                    container.querySelectorAll('.cat-wrapper').forEach(w => {
                        newDb[w.dataset.cat] = data[tab][w.dataset.cat];
                    });
                    data[tab] = newDb;
                }
            });
        }
    }

    function createCard(item, tab, cat, idx) {
        const div = document.createElement('div');
        const order = orders[item.n];
        let cls = "card"; let badges = "";
        if(order) {
            if(order.bf?.active) { cls+=" sel-bf"; badges+=`<span class="badge bg-bf">æ—©${order.bf.count>1?'x'+order.bf.count:''}</span>`; }
            if(order.lunch?.active) { cls+=" sel-lunch"; badges+=`<span class="badge bg-lunch">åˆ${order.lunch.count>1?'x'+order.lunch.count:''}</span>`; }
            if(order.dinner?.active) { 
                if(cls.includes("sel-lunch")) cls="card sel-both"; else cls+=" sel-dinner";
                badges+=`<span class="badge ${order.dinner.mode==='prep'?'bg-prep':'bg-dinner'}">${order.dinner.mode==='prep'?'åˆ‡':'æ™š'}${order.dinner.count>1?'x'+order.dinner.count:''}</span>`;
            }
        }
        
        const imgUrl = item.img || `https://via.placeholder.com/150/FFF5E8/FF7E67?text=${item.n[0]}`;
        div.className = cls;
        div.innerHTML = `
            <img src="${imgUrl}" class="card-img">
            <div class="card-body"><div class="card-name">${item.n}</div><div>${badges}</div></div>
            <div class="card-mask">
                <div class="mini-btn" onclick="event.stopPropagation();openDishModal('${tab}','${cat}',${idx})">âœ ä¿®æ”¹</div>
            </div>
        `;
        div.onclick = () => { if(!document.body.classList.contains('edit-mode')) openOrderModal(item, tab); };
        return div;
    }

    function addCategory(tab) {
        const n = prompt("ç»™æ–°åˆ†ç±»èµ·ä¸ªåå­—ï¼š");
        if(n) {
            if(!data[tab]) data[tab] = {};
            if(data[tab][n]) { alert("è¿™ä¸ªåå­—å·²ç»æœ‰å•¦~"); return; }
            data[tab][n] = []; renderAll();
        }
    }
    function renameCat(tab, old) {
        const n = prompt("æ¢ä¸ªåå­—", old);
        if(n && n!==old && !data[tab][n]) {
            const items = data[tab][old];
            delete data[tab][old];
            data[tab][n] = items; renderAll();
        }
    }
    function delCat(tab, cat) {
        if(confirm(`ç¡®å®šè¦åˆ é™¤ã€${cat}ã€‘å—ï¼Ÿ`)) { delete data[tab][cat]; renderAll(); }
    }

    function openDishModal(tab, cat, idx) {
        editCtx = { tab, cat, idx, isNew: idx===-1 };
        const item = idx===-1 ? {n:"", prep:""} : data[tab][cat][idx];
        document.getElementById('dm-title').innerText = editCtx.isNew ? "âœ¨ æ·»åŠ ç¾é£Ÿ" : "âœ¨ ä¿®æ”¹ç¾é£Ÿ";
        document.getElementById('dm-name').value = item.n;
        document.getElementById('dm-prep').value = item.prep || "";
        document.getElementById('dm-preview').style.backgroundImage = item.img ? `url(${item.img})` : "none";
        document.getElementById('dm-img-data').value = item.img || "";
        document.getElementById('dm-btn-del').style.display = editCtx.isNew ? 'none' : 'block';
        document.getElementById('dishModal').classList.add('show');
    }
    function handleFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const scale = 300/img.width;
                    cvs.width=300; cvs.height=img.height*scale;
                    cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                    const zip = cvs.toDataURL('image/jpeg', 0.7);
                    document.getElementById('dm-preview').style.backgroundImage = `url(${zip})`;
                    document.getElementById('dm-img-data').value = zip;
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    function saveDishTemp() {
        const n = document.getElementById('dm-name').value; if(!n) return;
        const item = { n, img: document.getElementById('dm-img-data').value, prep: document.getElementById('dm-prep').value };
        if(editCtx.isNew) data[editCtx.tab][editCtx.cat].push(item);
        else data[editCtx.tab][editCtx.cat][editCtx.idx] = item;
        closeModal('dishModal'); renderAll();
    }
    function deleteDish() {
        if(confirm("çœŸçš„è¦åˆ æ‰è¿™ä¸ªèœå—ï¼Ÿ")) {
            data[editCtx.tab][editCtx.cat].splice(editCtx.idx, 1);
            delete orders[document.getElementById('dm-name').value];
            closeModal('dishModal'); renderAll();
        }
    }

    function openOrderModal(item, tab) {
        orderCtx = { item, tab };
        const order = orders[item.n] || {};
        document.getElementById('om-title').innerText = item.n;
        
        document.getElementById('panel-bf').style.display = tab==='bf'?'block':'none';
        document.getElementById('panel-main').style.display = tab==='main'?'block':'none';
        
        document.getElementById('note-bf').value = "";
        document.getElementById('note-lunch').value = "";
        document.getElementById('note-dinner').value = "";

        if(tab === 'bf') {
            updateUI('bf', order.bf);
            if (!order.bf || !order.bf.active) { toggleMeal('bf'); }
        } else {
            updateUI('lunch', order.lunch);
            updateUI('dinner', order.dinner);
            
            const mode = order.dinner?.mode || 'cook';
            setDinnerMode(mode, false);
            
            if (order.dinner?.note) {
                document.getElementById('note-dinner').value = order.dinner.note;
            } else if (mode === 'prep' && item.prep) {
                document.getElementById('note-dinner').value = item.prep;
            }
        }
        document.getElementById('orderModal').classList.add('show');
    }

    function toggleMeal(t) {
        const sec = document.getElementById(t==='bf'?'sec-bf':(t==='lunch'?'sec-lunch':'sec-dinner'));
        const chk = document.getElementById(t==='bf'?'chk-bf':(t==='lunch'?'chk-lunch':'chk-dinner'));
        const cls = t==='bf'?'active-bf':'active';
        // æ ¸å¿ƒä¿®æ”¹ï¼šåˆ‡æ¢ç±»ï¼Œå¹¶æ›´æ–°å›¾æ ‡
        sec.classList.toggle(cls);
        if(sec.classList.contains(cls)) {
            chk.innerHTML = "â¤ï¸"; 
            const qtyId = t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner');
            if(document.getElementById(qtyId).innerText === "0") document.getElementById(qtyId).innerText = "1";
        } else {
            chk.innerHTML = "";
        }
    }

    function updateUI(t, d) {
        const sec = document.getElementById(t==='bf'?'sec-bf':(t==='lunch'?'sec-lunch':'sec-dinner'));
        const chk = document.getElementById(t==='bf'?'chk-bf':(t==='lunch'?'chk-lunch':'chk-dinner'));
        const qty = document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner'));
        const note = document.getElementById(t==='bf'?'note-bf':(t==='lunch'?'note-lunch':'note-dinner'));
        const cls = t==='bf'?'active-bf':'active';

        if(d && d.active) {
            sec.classList.add(cls);
            chk.innerHTML = "â¤ï¸";
            qty.innerText = d.count;
            if(t!=='dinner') note.value = d.note || "";
        } else {
            sec.classList.remove(cls);
            chk.innerHTML = "";
            qty.innerText = "1";
        }
    }

    function confirmOrder() {
        const item = orderCtx.item;
        if(!orders[item.n]) orders[item.n] = {};
        
        if(orderCtx.tab === 'bf') {
            if(document.getElementById('sec-bf').classList.contains('active-bf')) {
                orders[item.n].bf = { active:true, count:getQty('bf'), note:getVal('note-bf') };
            } else {
                delete orders[item.n].bf;
            }
        } else {
            if(document.getElementById('sec-lunch').classList.contains('active')) {
                orders[item.n].lunch = { active:true, count:getQty('lunch'), note:getVal('note-lunch') };
            } else delete orders[item.n].lunch;
            
            if(document.getElementById('sec-dinner').classList.contains('active')) {
                const mode = document.getElementById('sec-dinner').dataset.mode||'cook';
                const note = getVal('note-dinner');
                orders[item.n].dinner = { active:true, count:getQty('dinner'), mode:mode, note:note };
                if (mode === 'prep' && note) { item.prep = note; saveData(); }
            } else delete orders[item.n].dinner;
        }
        closeModal('orderModal'); renderAll();
    }

    function getQty(t) { return parseInt(document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner')).innerText); }
    function getVal(id) { return document.getElementById(id).value; }
    function adjQty(t, d) {
        const el = document.getElementById(t==='bf'?'qty-bf':(t==='lunch'?'qty-lunch':'qty-dinner'));
        let v = parseInt(el.innerText) + d; if(v<1) v=1; el.innerText = v;
    }
    function setDinnerMode(m, ui=true) {
        document.getElementById('sec-dinner').dataset.mode = m;
        document.getElementById('opt-cook').className = m==='cook'?'toggle-opt selected':'toggle-opt';
        document.getElementById('opt-prep').className = m==='prep'?'toggle-opt selected':'toggle-opt';
        if(ui) {
            const noteInput = document.getElementById('note-dinner');
            if(m==='prep') noteInput.value = orderCtx.item.prep || "";
            else noteInput.value = ""; 
        }
    }
    
    function renderSettings() {
        renderChips('chips-bfPpl', data.options.bfPpl, 'bfPpl');
        renderChips('chips-lunchPpl', data.options.lunchPpl, 'lunchPpl');
        renderChips('chips-dinnerRice', data.options.dinnerRice, 'dinnerRice');
    }
    function renderChips(id, list, key) {
        const el = document.getElementById(id); el.innerHTML="";
        list.forEach((txt, i)=>{
            const isSel = (key==='bfPpl' && tmpB===txt) || (key==='lunchPpl' && tmpL===txt) || (key==='dinnerRice' && tmpD===txt);
            const d = document.createElement('div');
            // ä¿®å¤æ ·å¼ç±»
            let cls = '';
            if(isSel) {
                if(key==='bfPpl') cls='bf-active';
                if(key==='lunchPpl') cls='lunch-active';
                if(key==='dinnerRice') cls='dinner-active';
            }
            d.className = `chip ${cls}`;
            d.innerHTML = `${txt}<div class="chip-del" onclick="event.stopPropagation();delOpt('${key}',${i})">Ã—</div>`;
            d.onclick = () => {
                if(!document.body.classList.contains('edit-mode')) {
                    if(key==='bfPpl') tmpB = (tmpB===txt?"":txt);
                    else if(key==='lunchPpl') tmpL = (tmpL===txt?"":txt);
                    else tmpD = (tmpD===txt?"":txt);
                    renderSettings();
                }
            };
            el.appendChild(d);
        });
        const add = document.createElement('div'); add.className="chip"; add.style.border="1px dashed #FFD1C7"; add.style.background="white"; add.style.color="var(--primary)"; add.innerHTML="+";
        add.onclick=()=>{ if(document.body.classList.contains('edit-mode')) {const v=prompt("æ·»åŠ é€‰é¡¹"); if(v){data.options[key].push(v); renderSettings();}} };
        el.appendChild(add);
    }
    function delOpt(k,i) { data.options[k].splice(i,1); renderSettings(); }
    function editLabel(k) { const v=prompt("æ–°æ ‡é¢˜", data.labels[k]); if(v){data.labels[k]=v; renderSettings();} }
    
    function generate() {
        const btn = document.getElementById('btn-copy');
        btn.innerText = "ğŸ“„ å¤åˆ¶ç»™é˜¿å§¨";
        btn.style.backgroundColor = "var(--primary)";

        let msg = "é˜¿å§¨ï¼Œæ˜å¤©é¥­èœå®‰æ’ï¼š\n";
        let bf=[], lu=[], di=[];
        
        for(let k in orders) {
            if(orders[k].bf?.active) bf.push(`${k}${orders[k].bf.count>1?' x'+orders[k].bf.count:''} ${orders[k].bf.note?('('+orders[k].bf.note+')'):''}`);
            if(orders[k].lunch?.active) lu.push(`${k}${orders[k].lunch.count>1?' x'+orders[k].lunch.count:''} ${orders[k].lunch.note?('('+orders[k].lunch.note+')'):''}`);
            if(orders[k].dinner?.active) {
                const d=orders[k].dinner;
                di.push(`${d.mode==='prep'?'ğŸ”ª ':'ğŸ³ '}${k}${d.count>1?' x'+d.count:''} ${d.note?('('+d.note+')'):''}`);
            }
        }
        
        if(bf.length||tmpB) msg+=`\nâ˜€ï¸ã€æ—©é¤ã€‘${tmpB?(' '+tmpB):''}\n${bf.join('ï¼Œ')}`;
        
        if(lu.length||tmpL) msg+=`\n\nğŸ±ã€ä¸­é¤ã€‘${tmpL?(' '+tmpL):''}\n${lu.join('ï¼Œ')}${document.getElementById('input-lunch-extra').value?('\nè¡¥å……: '+document.getElementById('input-lunch-extra').value):''}`;
        
        if(di.length||tmpD) msg+=`\n\nğŸŒ™ã€æ™šé¤ã€‘${tmpD?(' '+tmpD):''}\n${di.join('\n')}${document.getElementById('input-dinner-extra').value?('\nè¡¥å……: '+document.getElementById('input-dinner-extra').value):''}`;
        
        const gn = document.getElementById('global-note').value;
        if(gn) msg+=`\n\nğŸ“ã€å¤‡æ³¨ã€‘\n${gn}`;
        msg+="\n\nè¾›è‹¦é˜¿å§¨äº†ï¼";
        
        document.getElementById('final-text').value=msg; document.getElementById('resultModal').classList.add('show');
    }
    
    function copyText(){ 
        document.getElementById('final-text').select(); 
        document.execCommand('copy'); 
        const btn = document.getElementById('btn-copy');
        btn.innerText = "âœ… å¤åˆ¶æˆåŠŸå•¦";
        btn.style.backgroundColor = "#6BCB77";
    }
    
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function switchTab(t){ 
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
        document.getElementById('tab-'+t).classList.add('active');
    }

    init();
</script>
</body>
</html>
